---
title: "K-mer approach to Lewontin's paradox results"
author: "Miles Roberts"
date: "2024-04-03"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

# load packages
```{r}
rm(list = ls())

# remove.packages(c("dplyr", "ggplot2", "caper", "stringr", "data.table", "cowplot", "rWCVP", "lwgeom", "sf"))

library(dplyr)
library(ggplot2)
library(caper)
library(stringr)
library(data.table)
#library(cowplot)
#library(scico)
#library(giscoR)
library(rWCVP)
library(lwgeom)
library(sf)
library(ggpubr)
library(broom)


today = Sys.Date()
```

# Data preparation

## Prepare diversity data 
```{r}
# List input files
pi = list.files("../results/2023-03-26/genome-wide-pi", full.names = T)
bcd = list.files("../results/2023-03-26/bray-curtis-dissimilarities", full.names = T)
jac = list.files("../results/2023-03-26/jaccard-dissimilarities", full.names = T)

# for now, remove species that can't be processed further for whatever reason
# pi: panicum virgatum
# jac and bcd: panicum hallii, lens culinaris
jac = jac[c(-56, -81)]
bcd = bcd[c(-56, -81)]
pi = pi[c(-80)]

# get species IDs
species = gsub("_pairwise-pi.txt", "", gsub("../results/2023-03-26/genome-wide-pi/", "", pi))

# Load input files
pi = lapply(pi, fread, header = T, data.table = F)
bcd = lapply(bcd, fread, header = F, data.table = F)
jac = lapply(jac, fread, header = F, data.table = F)

# calculate mean pairwise dissimilarity
bcdMean = lapply(bcd, function(x){mean(x[,2])})
jacMean = lapply(jac, function(x){mean(x[,2])})

# calculate average number of k-mer differences as union - intersection
unionMean = lapply(jac, function(x){sum(x[,4]-x[,3])})

# calculate number of individuals sampled for each dataset
# You get this equation by rewriting the formula for the number of pairwise comparisons (n^2 - n)/2 = N as a polynomial and applying the quadratic formula
backCalcN = function(x){
  sqrt(1/4 + 2*nrow(x)) + 1/2
}

nidv = lapply(bcd, backCalcN)

# cbind all diversity data into one dataframe per species
alldiv = Map(cbind, pi, bcdMean, jacMean, unionMean, nidv)

# Some species have extra data, remove for now
speciesWithExtraData = which(unlist(lapply(alldiv, ncol)) == 12)
for(i in speciesWithExtraData){
  alldiv[[i]] = alldiv[[i]][,c(1, 3:6, 9:12)]
}

# rbind all species data into one dataframe
alldiv = lapply(alldiv, setNames, c("h", "ntotal", "nvariant", "ninvariant", "pi", "bcd", "jac", "umean", "nidv"))

alldiv = do.call(rbind, alldiv)

# add species names
alldiv$species = species
alldiv$species = str_to_sentence(gsub("_", " ", alldiv$species))

# For now, remove species where invariant sites were not properly called
# alldiv = alldiv[(alldiv$ninvariant > 0),]

# For now, remove species where variants sites were not properly called
# alldiv = alldiv[(alldiv$nvariant > 30),]

# remove species where there aren't many sampled individuals
# alldiv = alldiv[(alldiv$nidv >= 10),]

# add coverage covariate
coverage = read.table("../results/2023-03-26/bp_sequenced_2024-04-03.txt", header = T, sep = "\t")
alldiv = merge(alldiv, coverage, by = "species", all.x = TRUE)

# remove temporary objects
rm(pi, jac, bcd, coverage, bcdMean, jacMean, unionMean, nidv)

# 
# gsize = read.table("../results/2023-03-26/genome_size.txt", header = T, sep = "\t")
# alldiv = merge(alldiv, gsize, by = "species")
# 
# alldiv$totalcov = alldiv$totalbp/alldiv$assemblySize
```

## Load range data
```{r}
# load range data
areas = list.files("../results/2023-03-26/ranges/areas", full.names = T)

# remove files with no data
# Cicer arietinum
#areas = areas[c(-33)]

# extract species names
areas_species = gsub("_areas.txt", "", gsub("../results/2023-03-26/ranges/areas/", "", areas))
areas_species = str_to_sentence(gsub("_", " ", areas_species))

# load data
areas = lapply(areas, read.table, header = +T, sep = "\t")

# add names to list
names(areas) = areas_species

# copy object so that we can separate out whether invaded areas are included or not
native_areas = areas
```

## remove areas outside of native range 
```{r}
# Refer to plants of the world online for native range maps
# powo.science.kew.org

# Amaranthus hybridus native to only North and South America
native_areas$`Amaranthus hypochondriacus` = native_areas$`Amaranthus hypochondriacus`[1:2,]

# Arabidopsis thaliana is only native to Europe, Asia, and Africa
native_areas$`Arabidopsis thaliana` = native_areas$`Arabidopsis thaliana`[2:4,]

# Arachis duranensis is native to south america, remove asia
native_areas$`Arachis duranensis` = native_areas$`Arachis duranensis`[1,]

# Arachis glabrata is native to Brazil, remove North America
native_areas$`Arachis hypogaea` = native_areas$`Arachis hypogaea`[2,]

# Beta vulgaris subsp. vulgaris is native to only Europe and Africa
native_areas$`Beta vulgaris` = native_areas$`Beta vulgaris`[2:3,]

# Brachypodium distachyon is native to Europe, Asia, Africa
native_areas$`Brachypodium distachyon` = native_areas$`Brachypodium distachyon`[2:4,]

# Brassica juncea is native only to Europe
native_areas$`Brassica juncea` = native_areas$`Brassica juncea`[4,]

# Brassica cretica native to europe
native_areas$`Brassica oleracea` = native_areas$`Brassica oleracea`[1,]

# Brassica fruticulosa native to europe
native_areas$`Brassica rapa` = native_areas$`Brassica rapa`[2,]

# Buddleja alternifolia is native to Asia
native_areas$`Buddleja alternifolia` = native_areas$`Buddleja alternifolia`[2,]

# Cajanus scarabaeoides native to Africa, Asia, Australia
native_areas$`Cajanus cajan` = native_areas$`Cajanus cajan`[c(1,3,4),]

# Camelina sativa is not native to North America
native_areas$`Camelina sativa` = native_areas$`Camelina sativa`[c(2,3),]

# Cannabis sativa is native only to Asia
native_areas$`Cannabis sativa` = native_areas$`Cannabis sativa`[5,]

# Capsicum annuum is native to north america and south america
native_areas$`Capsicum annuum` = native_areas$`Capsicum annuum`[c(1,2),]

# Castanea mollissima is native only to asia
native_areas$`Castanea mollissima` = native_areas$`Castanea mollissima`[2,]

# Cucumis myriocarpus is native only to africa
native_areas$`Cucumis melo` = native_areas$`Cucumis melo`[2,]

# Cucurbita palmata is only native to North America
native_areas$`Cucurbita pepo` = native_areas$`Cucurbita pepo`[1,]

# Digitaria longiflora native to africa, asia, australia
native_areas$`Digitaria exilis`= native_areas$`Digitaria exilis`[2:4,]

# Dioscorea communis is native only to africa
native_areas$`Dioscorea rotundata` = native_areas$`Dioscorea rotundata`[2,]

# Gossypium arboreum native to asia
native_areas$`Gossypium arboreum` = native_areas$`Gossypium arboreum`[3,]

# Gossypium thurberi is native only to north america
native_areas$`Gossypium hirsutum` = native_areas$`Gossypium hirsutum`[1,]

# Helianthus maximiliani is native only to north america
native_areas$`Helianthus annuus` = native_areas$`Helianthus annuus`[1,]

# Juglans mandshuica is native only to asia
native_areas$`Juglans regia` = native_areas$`Juglans regia`[2,]

# Lactuca sativa is native to Iraq
native_areas$`Lactuca sativa` = native_areas$`Lactuca sativa`[3,]

# Linum bienne is native to europe, africa, and asia
native_areas$`Linum usitatissimum` = native_areas$`Linum usitatissimum`[c(3,4),]

# Malus sylvestris is only native to Europe
native_areas$`Malus sylvestris` = native_areas$`Malus sylvestris`[2,]

# Medicago truncatula only native to europe and africa
native_areas$`Medicago truncatula` = native_areas$`Medicago truncatula`[c(4,5),]

# Mimulus guttatus only native to North America
native_areas$`Mimulus guttatus` = native_areas$`Mimulus guttatus`[1,]

# Miscanthus sacchariflorus is native only to asia
native_areas$`Miscanthus sinensis` = native_areas$`Miscanthus sinensis`[3,]

# Musa relative only native to asia and india
native_areas$`Musa acuminata` = native_areas$`Musa acuminata`[2,]

# Nicotiana glauca is native only to south america
native_areas$`Nicotiana tabacum` = native_areas$`Nicotiana tabacum`[2,]

# Oryza rufipogon is native to asia and australia
native_areas$`Oryza rufipogon` = native_areas$`Oryza rufipogon`[c(2,3),]

# Panicum hallii is native only to north america
native_areas$`Panicum hallii` = native_areas$`Panicum hallii`[1,]

# Panicum capillare is native only to north america
native_areas$`Panicum virgatum` = native_areas$`Panicum virgatum`[1,]

# Papaver rhoeas is native to Africa, Europe, Asia
native_areas$`Papaver somniferum` = native_areas$`Papaver somniferum`[4:6,]

# Populus deltoides only native to north america
native_areas$`Populus deltoides` = native_areas$`Populus deltoides`[1,]

# Prunus avium is native to europe, asia, africa
native_areas$`Prunus avium` = native_areas$`Prunus avium`[2:3,]

# Raphanus raphanistrum is native to europe and africa
native_areas$`Raphanus sativus` = native_areas$`Raphanus sativus`[3:4,]

# Setaria faberi is native only to asia
native_areas$`Setaria italica` = native_areas$`Setaria italica`[3,]

# Setaria viridis is native to europe, africa, asia, australia
native_areas$`Setaria viridis` = native_areas$`Setaria viridis`[2:5,]

# Thlaspi arvense is native to europe and asia
native_areas$`Thlaspi arvense` = native_areas$`Thlaspi arvense`[3:4,]

# Triticum urartu is native only to asia 
native_areas$`Triticum aestivum` = native_areas$`Triticum aestivum`[2,]
```

## Merge range data with diversity data
```{r}
# function to get non-water area
get_nonwater_area = function(x){
  sum(x[,"total_area"] - x[,"water_area"])
}

# format area data as frame
areas_frame = data.frame(
  species = areas_species,
  gbif_all_area = unlist(lapply(areas, get_nonwater_area)),
  gbif_native_area = unlist(lapply(native_areas, get_nonwater_area))
)

# manually correct gossypium barbadense because galapagos was incorrectly counted as water
areas_frame$gbif_all_area[(areas_frame$species == "Gossypium barbadense")] = areas$`Gossypium barbadense`$total_area
areas_frame$gbif_native_area[(areas_frame$species == "Gossypium barbadense")] = areas$`Gossypium barbadense`$total_area

# merge with diversity data
alldiv = merge(alldiv, areas_frame, by = "species", all.x = T)
print(alldiv)

# save final table
#write.csv(alldiv, paste("../results/2023-03-26/diversityAndRangeData_", today, ".csv", sep = ""), row.names = F, quote = F)
```



## Load range areas
```{r}
# load local copies of World Checklist of Vascular Plants
wcvp_dist = fread("../workflow/data/range/wcvp_distribution.csv.gz", sep = "|", header = T, quote = "", fill = T, encoding = "UTF-8")

wcvp_names = fread("../workflow/data/range/wcvp_names.csv.gz", sep = "|", header = T, quote = "", fill = T, encoding = "UTF-8")

# update species names to match latest names in WCVP
updated_species_names = data.frame(species = unique(alldiv$species),species_updated = unique(alldiv$species))

updated_species_names$species_updated[updated_species_names$species == "Arabis nemorensis"] = "Arabis planisiliqua"
updated_species_names$species_updated[updated_species_names$species == "Dioscorea rotundata"] = "Dioscorea cayenensis subsp. rotundata"
updated_species_names$species_updated[updated_species_names$species == "Glycine soja"] = "Glycine max subsp. soja"
updated_species_names$species_updated[updated_species_names$species == "Lens ervoides"] = "Vicia lenticula"
updated_species_names$species_updated[updated_species_names$species == "Mimulus guttatus"] = "Erythranthe guttata"
updated_species_names$species_updated[updated_species_names$species == "Populus trichocarpa"] = "Populus tristis"
updated_species_names$species_updated[updated_species_names$species == "Raphanus sativus"] = "Raphanus raphanistrum subsp. sativus"
updated_species_names$species_updated[updated_species_names$species == "Salix dunnii"] = "Salix tetrasperma"
updated_species_names$species_updated[updated_species_names$species == "Solanum stenotomum"] = "Solanum tuberosum"
updated_species_names$species_updated[updated_species_names$species == "Boechera stricta"] = "Boechera drummondii"

# loop over each species, and calculate range area in square kilometers
region_areas = NULL

for(species in updated_species_names$species_updated){

  print(species)
  
  # get native distribution
species_dist = wcvp_distribution(
taxon = species,
taxon_rank = "species",
native = TRUE,
introduced = FALSE,
extinct = TRUE,
location_doubtful = FALSE,
wcvp_distributions = wcvp_dist,
wcvp_names = wcvp_names
)

# get native + invaded species distribution
species_dist_invaded = wcvp_distribution(
taxon = species,
taxon_rank = "species",
native = TRUE,
introduced = TRUE,
extinct = TRUE,
location_doubtful = FALSE,
wcvp_distributions = wcvp_dist,
wcvp_names = wcvp_names
)

# calculate area, convert to square kilometers (1000 x 1000 meters)
region_area = sum(st_area(species_dist))/1e6
region_area_invaded = sum(st_area(species_dist_invaded))/1e6

region_areas = rbind(region_areas, data.frame(species_updated = species, wcvp_native_area = region_area, wcvp_all_area = region_area_invaded))

}

# merge range areas with old species names
region_areas = merge(updated_species_names, region_areas, by = "species_updated")

# remove weird units
region_areas$wcvp_native_area = as.numeric(region_areas$wcvp_native_area)
region_areas$wcvp_all_area = as.numeric(region_areas$wcvp_all_area)

# merge with diversity data
alldiv = merge(alldiv, region_areas, by = "species")

# remove temporary objects
rm(wcvp_dist, wcvp_names, region_areas)
```

## Load plant height data, a proxy for body size, which is a proxy for population density
```{r}
height = fread("../workflow/data/eol_plant_height_data_2023-10-03/records.tsv.gz", header = T, fill = T, quote = "", sep = "\t")

# convert feet to meters
height$final_values = height$`Measurement Value`
height$final_values[(height$`Measurement Unit` == "feet")] = height$final_values[(height$`Measurement Unit` == "feet")]*0.3048

# get height measurements for only species in my dataset
height_my_species = NULL
for(i in 1:nrow(alldiv)){
  # print progress
  print(i)
  
  # get species name(s)
  old_name = alldiv$species[i]
  new_name = alldiv$species_updated[i]
  
  # check old name
  height_sub = height[grepl(old_name, height$`Scientific Name`),]
  
  # if new name is different, check new species name
  if(new_name != old_name){
    height_sub = rbind(height_sub, height[grepl(new_name, height$`Scientific Name`),])
  }
  
  # average across values
  height_one_species = data.frame(species = old_name, height = mean(height_sub$final_values, na.rm = T))
  height_my_species = rbind(height_my_species, height_one_species)
}

# add height data to final dataframe
summary(height_my_species$height)
alldiv = merge(alldiv, height_my_species, all.x = T, by = "species")
```

## genome size, ploidy, mating system data
```{r}
# load extra species metadata
metadata = read.table("../results/2023-03-26/species_metadata_2024-04-03.txt", sep = "\t", fill = T, quote = "", header = T)
names(metadata)[1] = "species"

# remove weird space character
metadata$species = gsub("<a0>", " ", metadata$species)
metadata$species = gsub(" $", "", metadata$species)

# merge metadata with diversity data
alldiv = merge(alldiv, metadata[,c("species", "DNA.amount..1.C..pg.", "Mating.system", "Ploidy", "Height..m.", "cultivation.status", "Generation.time")], by = "species", all.x = T)

# collapse life cycle habit into annual vs not annual
table(alldiv$Generation.time)
alldiv$Generation.time[(alldiv$Generation.time != "annual")] = "perennial.biennial.mixed"
table(alldiv$Generation.time)

# collapse clonal species into outcrossing
# collapse mixed mating into outcrossing
table(alldiv$Mating.system)
alldiv$Mating.system[(alldiv$Mating.system != "outcrossing")] = "selfing.mixed.clonal"
table(alldiv$Mating.system)

# combine different height columns into one
alldiv$height_final = alldiv$height
alldiv$height_final[is.na(alldiv$height_final)] = alldiv$Height..m.[is.na(alldiv$height_final)]

# calculate quantity that's proportional to population size (range/squared height)
alldiv$wcvp_all_popsize = (alldiv$wcvp_all_area * 1e6)/(alldiv$height_final^2)
summary(alldiv$wcvp_all_popsize)

alldiv$wcvp_native_popsize = (alldiv$wcvp_native_area * 1e6)/(alldiv$height_final^2)
summary(alldiv$wcvp_native_popsize)

alldiv$gbif_all_popsize = (alldiv$gbif_all_area * 1e6)/(alldiv$height_final^2)
summary(alldiv$gbif_all_popsize)

alldiv$gbif_native_popsize = (alldiv$gbif_native_area * 1e6)/(alldiv$height_final^2)
summary(alldiv$gbif_native_popsize)

# convert genome size in picograms to megabases
alldiv$genome.size = alldiv$DNA.amount..1.C..pg. * 0.978e9

# calculate average coverage per individual
#alldiv$totalbp[(alldiv$species == "Cicer arietinum")] = 7.5e12 # chickpea was subset
#alldiv$totalbp[(alldiv$species == "Glycine max")] = 7.5e12 # soybean was subset
#alldiv$totalbp[(alldiv$species == "Gossypium hirsutum")] = 7.5e12 # cotton was subset

alldiv$meancov = alldiv$totalbp/(alldiv$genome.size*alldiv$nidv)

# re-order mating system variable
alldiv$Mating.system = factor(alldiv$Mating.system, levels = c("selfing.mixed.clonal", "outcrossing"))
```

## save final organized dataframe
```{r eval=FALSE, include=FALSE}
write.table(alldiv, paste("final_covariates_", today, ".txt", sep = ""), row.names = F, quote = F, sep = "\t")
```

# Initial data analysis

## load saved data for plotting
```{r eval=FALSE, include=FALSE}
alldiv = read.table("../results/2023-03-26/final_covariates_2024-04-03.txt", sep = "\t", header = T)
```

## Prepare phylogenetic tree
```{r}
# write species list to upload to timetree.org, converting some names to those recognized by timetree
timetree_names = alldiv$species
timetree_names[(timetree_names == "Brassica rapa")] = "Brassica rapa subsp. rapa"
timetree_names[(timetree_names == "Brassica oleracea")] = "Brassica oleracea var. capitata"
timetree_names[(timetree_names == "Solanum stenotomum")] = "Solanum tuberosum"
timetree_names[(timetree_names == "Chenopodium quinoa")] = "Chenopodium album"
timetree_names[(timetree_names == "Oryza sativa")] = "Oryza sativa Indica Group"

#write.table(timetree_names, paste("../results/2023-03-26/species_list_", today, ".txt", sep = ""), row.names = F, col.names = F, quote = F)

# load time tree from timetree.org
phy = read.tree("../results/2023-03-26/species_list_2024-04-03.nwk")

# remove underscores
phy$tip.label = gsub("_", " ", phy$tip.label)

# remove variety and subspecies names, convert tip labels to my standard
phy$tip.label = gsub(" var\\..*", "", phy$tip.label)
phy$tip.label = gsub(" subsp\\..*", "", phy$tip.label)

phy$tip.label[(phy$tip.label == "Solanum tuberosum")] = "Solanum stenotomum"
phy$tip.label[(phy$tip.label == "Chenopodium album")] = "Chenopodium quinoa"
phy$tip.label[(phy$tip.label == "Erythranthe guttata")] = "Mimulus guttatus"
phy$tip.label[(phy$tip.label == "Oryza sativa Indica Group")] = "Oryza sativa"

# sanity check
plot(phy)

# check that all species I have data for are in phylogeny and vice versa. Output should be TRUE
all(alldiv$species %in% phy$tip.label)
all(phy$tip.label %in% alldiv$species)
#alldiv$species[!(alldiv$species %in% phy$tip.label)]
```

## plot raw relationships between study variables

```{r}
# scico(2, palette = "lapaz")
# "#190C64" "#FEF2F2"

# collapse long names
alldiv$Generation.time[(alldiv$Generation.time == "perennial.biennial.mixed")] = "not\nannual"
alldiv$Mating.system[(alldiv$Mating.system == "selfing.mixed.clonal")] = "not\noutcrossing"

# check relationship between categorical variables
table(alldiv$Mating.system, alldiv$cultivation.status)
table(alldiv$Mating.system, alldiv$Generation.time)
table(alldiv$Generation.time, alldiv$cultivation.status)

chisq.test(alldiv$Mating.system, alldiv$cultivation.status)
chisq.test(alldiv$Mating.system, alldiv$Generation.time)
chisq.test(alldiv$Generation.time, alldiv$cultivation.status)

# function for simple scatterplot
my_ggplot_wrap <- function(data, xcol, ycol, xname, yname, filename, filew = 5, fileh = 5) {
  
  # get correlation coefficient
  x = with(data, eval(str2expression(xcol)))
  y = with(data, eval(str2expression(ycol)))
  test_results = cor.test(x, y, method = "spearman")
  
  # create label
  cor_label = signif(test_results$estimate, digits = 2)
  p_label = signif(test_results$p.value, digits = 2)
  result_label = paste("\U03C1 = ", cor_label, ", ", "p = ", p_label, sep = "")
  
  # plot
  myplot = ggplot(data = data, aes_string(x = xcol, y = ycol)) + 
    geom_point() +
    geom_smooth(method = "loess", color = "purple") +
    theme_classic() +
    #stat_cor(method = "spearman", digits = 2, cor.coef.name = "rho", size = 7) +
    labs(x = xname, y = yname, title = result_label) +
    theme(text = element_text(size = 12))
  
  myplot
  ggsave(filename, width = filew, height = fileh)

  return(myplot)
}

# function to color points by third variable
my_ggplot_wrap_xyz <- function(data, xcol, ycol, xname, yname, filename, zcol, lcol, hcol, lname, mylims, filew = 5, fileh = 5) {
  
  # get correlation coefficient
  x = with(data, eval(str2expression(xcol)))
  y = with(data, eval(str2expression(ycol)))
  test_results = cor.test(x, y, method = "spearman")
  
  # create label
  cor_label = signif(test_results$estimate, digits = 2)
  p_label = signif(test_results$p.value, digits = 2)
  result_label = paste("\U03C1 = ", cor_label, ", ", "p = ", p_label, sep = "")
  
  myplot = ggplot(data = data, aes_string(x = xcol, y = ycol, color = zcol)) + 
    geom_point() +
    geom_smooth(method = "loess", color = "purple", n = 20) +
    theme_classic() +
    #stat_cor(method = "spearman", digits = 2, cor.coef.name = "rho", size = 7) +
    scale_color_gradient(low = lcol, high = hcol, name = lname, limits = mylims) +
    labs(x = xname, y = yname, title = result_label) +
    theme(text = element_text(size = 12))
  
  myplot
  ggsave(filename, width = filew, height = fileh)

  return(myplot)
}

# function to create boxplots
my_ggplot_wrap_box <- function(data, xcol, ycol, xname, yname, filename, filew = 5, fileh = 5) {
  myplot = ggplot(data = data, aes_string(x = xcol, y = ycol)) + 
    geom_boxplot() +
    theme_classic() +
    theme(text = element_text(size = 12)) +
    #stat_kruskal_test(size = 7) +
    #stat_anova_test(type = 3, method = "one_way") +
    labs(x = xname, y = yname)
  
  myplot
  ggsave(filename, width = filew, height = fileh)

  return(myplot)
}

# function to have scatterplot with linear model + 1:1 line
my_ggplot_wrap_line <- function(data, xcol, ycol, xname, yname, filename, filew = 5, fileh = 5) {
  # get correlation coefficient
  x = with(data, eval(str2expression(xcol)))
  y = with(data, eval(str2expression(ycol)))
  test_results = cor.test(x, y, method = "spearman")
  
  # create label
  cor_label = signif(test_results$estimate, digits = 2)
  p_label = signif(test_results$p.value, digits = 2)
  result_label = paste("\U03C1 = ", cor_label, ", ", "p = ", p_label, sep = "")
  
  # combine everything into a plot
  myplot = ggplot(data = data, aes_string(x = xcol, y = ycol)) + 
    geom_point() +
    geom_abline(slope = 1, intercept = 0) +
    geom_smooth(method = "lm", color = "purple") + 
    theme_classic() +
    #stat_cor(method = "spearman", digits = 2, cor.coef.name = "rho", size = 7) +
    labs(x = xname, y = yname, title = result_label) +
    theme(text = element_text(size = 12))
  
  myplot
  ggsave(filename, width = filew, height = fileh)

  return(myplot)
}

# function to have scatterplot with linear model only
my_ggplot_wrap_lm <- function(data, xcol, ycol, xname, yname, filename, filew = 5, fileh = 5) {
  # get correlation coefficient
  x = with(data, eval(str2expression(xcol)))
  y = with(data, eval(str2expression(ycol)))
  test_results = cor.test(x, y, method = "spearman")
  
  # create label
  cor_label = signif(test_results$estimate, digits = 2)
  p_label = signif(test_results$p.value, digits = 2)
  result_label = paste("\U03C1 = ", cor_label, ", ", "p = ", p_label, sep = "")
  
  myplot = ggplot(data = data, aes_string(x = xcol, y = ycol)) + 
    geom_point() +
    geom_smooth(method = "lm", color = "purple") + 
    theme_classic() +
    #stat_cor(method = "spearman", digits = 2, cor.coef.name = "rho", size = 7) +
    labs(x = xname, y = yname, title = result_label) +
    theme(text = element_text(size = 12))
  
  myplot
  
  ggsave(filename, width = filew, height = fileh)

  return(myplot)
}

# compare two discrete variables
my_ggplot_wrap_barplot = function(data, var1, var2, xname, yname, lname, my_colors, filename, filew = 5, fileh = 5){
    
  # get chi-sq result
  x = with(data, eval(str2expression(var1)))
  y = with(data, eval(str2expression(var2)))
  test_results = chisq.test(x, y)
  
  # construct result label
  stat_label = signif(test_results$statistic, digits = 3)
  p_label = signif(test_results$p.value, digits = 2)
  #result_label = paste("\U03A7^2 = ", stat_label, ", ", "p = ", p_label, sep = "")
  result_label = substitute(paste(chi^2 == s, ", p =", myp), list(s = stat_label, myp = p_label))
  
  myplot = ggplot(alldiv, aes_string(x = var1, fill = var2)) +
    geom_bar(position = "dodge") +
    theme_classic() +
    theme(text = element_text(size = 12)) +
    scale_fill_manual(values = my_colors, name = lname) +
    labs(x = xname, y = yname, title = result_label)

  myplot
  
  ggsave(filename, width = filew, height = fileh)

  return(myplot)
}

# visualize relationship between categorical variables
ida_generation_vs_mating = my_ggplot_wrap_barplot(alldiv, "Generation.time", "Mating.system", "Life cycle habit", "Number of species", "Mating\nsystem", c("#65014B", "#0C4C00"), paste("ida_generation_vs_mating_", today, ".png", sep = ""))

ida_cultivation_vs_mating = my_ggplot_wrap_barplot(alldiv, "Mating.system", "cultivation.status", "Mating system", "Number of species", "Cultivation\nstatus", c("#8C0172", "#B2F2FD"), paste("ida_cultivation_vs_mating_", today, ".png", sep = ""))

ida_cultivation_vs_generation = my_ggplot_wrap_barplot(alldiv, "cultivation.status", "Generation.time", "Cultivation status", "Number of species", "Life cycle\nhabit", c("#9EB0FF", "#FFACAC"), paste("ida_cultivation_vs_generation_", today, ".png", sep = ""))

# scatterplots

## average coverage vs diversity
ida_meancov_vs_pi = my_ggplot_wrap(alldiv, "log10(meancov)", "log10(pi)", "log(mean coverage)", "log(Nucleotide diversity)", paste("ida_coverage-vs-pi_", today, ".png", sep = ""))

ida_meancov_vs_jac = my_ggplot_wrap(alldiv, "log10(meancov)", "jac", "log(mean coverage)", "Jaccard dissimilarity", paste("ida_coverage-vs-jac_", today, ".png", sep = ""))

ida_meancov_vs_bcd = my_ggplot_wrap(alldiv, "log10(meancov)", "bcd", "log(mean coverage)", "Bray-Curtis dissimilarity", paste("ida_coverage-vs-bcd_", today, ".png", sep = ""))

## depth of sequencing variation vs diversity
ida_cvbp_vs_pi = my_ggplot_wrap(alldiv, "cvbp", "log10(pi)", "Coeff. of variation in bp sequenced", "log(Nucleotide diversity)", paste("ida_cvbp-vs-pi_", today, ".png", sep = ""))

ida_cvbp_vs_jac = my_ggplot_wrap(alldiv, "cvbp", "jac", "Coeff. of variation in bp sequenced", "Jaccard dissimilarity", paste("ida_cvbp-vs-jac_", today, ".png", sep = ""))

ida_cvbp_vs_bcd = my_ggplot_wrap(alldiv, "cvbp", "bcd", "Coeff. of variation in bp sequenced", "Bray-Curtis dissimilarity", paste("ida_cvbp-vs-bcd_", today, ".png", sep = ""))

## number of individuals sequenced vs diversity
ida_nidv_vs_pi = my_ggplot_wrap(alldiv, "log10(nidv)", "log10(pi)", "log(Number of individuals)", "log(Nucleotide diversity)", paste("ida_nidv-vs-pi_", today, ".png", sep = ""))

ida_nidv_vs_jac = my_ggplot_wrap(alldiv, "log10(nidv)", "jac", "log(Number of individuals)", "Jaccard dissimilarity", paste("ida_nidv-vs-jac_", today, ".png", sep = ""))

ida_nidv_vs_bcd = my_ggplot_wrap(alldiv, "log10(nidv)", "bcd", "log(Number of individuals)", "Bray-Curtis dissimilarity", paste("ida_nidv-vs-bcd_", today, ".png", sep = ""))

## number of variant sites vs diversity
ida_nvariant_vs_pi = my_ggplot_wrap(alldiv, "log10(nvariant + 1)", "log10(pi)", "log(Number of variant sites + 1)", "log(Nucleotide diversity)", paste("ida_nvariant-vs-pi_", today, ".png", sep = ""))

# compare diversity, colored by coverage
ida_jac_vs_bcd = my_ggplot_wrap_lm(alldiv, "jac", "bcd", "Jaccard dissimilarity", "Bray-Curtis dissimilarity", paste("ida_jac-vs-bcd_", today, ".png", sep = ""))

ida_pi_vs_jac = my_ggplot_wrap_xyz(alldiv, "log10(pi)", "jac", 'log(Nucleotide diversity)', "Jaccard dissimilarity", paste("ida_pi-vs-jac_", today, ".png", sep = ""), "log10(meancov)", "#FEF2F2", "#190C64", 'log(mean coverage)', c(min(log10(alldiv$meancov)), max(log10(alldiv$meancov))))

ida_pi_vs_bcd = my_ggplot_wrap_xyz(alldiv, "log10(pi)", "bcd", "log(Nucleotide diversity)", "Bray-Curtis dissimilarity", paste("ida_pi-vs-bcd_", today, ".png", sep = ""), "log10(meancov)", "#FEF2F2", "#190C64", "log(mean coverage)", c(min(log10(alldiv$meancov)), max(log10(alldiv$meancov))))

# compare diversity measures, colored by variation in coverage
ida_pi_vs_jac_cvbp = my_ggplot_wrap_xyz(alldiv, "log10(pi)", "jac", "log10(Nucleotide diversity)", "Jaccard dissimilarity", paste("ida_pi-vs-jac_cvbp_", today, ".png", sep = ""), "cvbp", "#FEF2F2", "#190C64", "Coeff.\nof variation\nbp sequenced", c(min(alldiv$cvbp), max(alldiv$cvbp)))

ida_pi_vs_bcd_cvbp = my_ggplot_wrap_xyz(alldiv, "log10(pi)", "bcd", "log10(Nucleotide diversity)", "Bray-Curtis dissimilarity", paste("ida_pi-vs-bcd_cvbp_", today, ".png", sep = ""), "cvbp", "#FEF2F2", "#190C64", "Coeff.\nof variation\nbp sequenced", c(min(alldiv$cvbp), max(alldiv$cvbp)))

# compare diversity measures, colored by number of individuals sequenced
ida_pi_vs_jac_nidv = my_ggplot_wrap_xyz(alldiv, "log10(pi)", "jac", "log(Nucleotide diversity)", "Jaccard dissimilarity", paste("ida_pi-vs-jac_nidv_", today, ".png", sep = ""), "log10(nidv)", "#FEF2F2", "#190C64", "log(Number of\nindividuals\nsequenced)", c(min(log10(alldiv$nidv)), max(log10(alldiv$nidv))))

ida_pi_vs_bcd_nidv = my_ggplot_wrap_xyz(alldiv, "log10(pi)", "bcd", "log(Nucleotide diversity)", "Bray-Curtis dissimilarity", paste("ida_pi-vs-bcd_nidv_", today, ".png", sep = ""), "log10(nidv)", "#FEF2F2", "#190C64", "log(Number of\nindividuals\nsequenced)", c(min(log10(alldiv$nidv)), max(log10(alldiv$nidv))))

# compare k-mer diversity measures
my_ggplot_wrap_xyz(alldiv, "jac", "bcd", "Jaccard dissimilarity", "Bray-Curtis dissimilarity", paste("ida_jac-vs-bcd_", today, ".png", sep = ""), "log10(meancov)", "#FEF2F2", "#190C64", "log10(mean cov/sample)", c(min(log10(alldiv$meancov)), max(log10(alldiv$meancov))))

# compare population size estimates
ida_wcvp_vs_gbif_native = my_ggplot_wrap_line(alldiv, "log10(wcvp_native_area)", "log10(gbif_native_area)", expression("log(WCVP native range)"~km^2), expression("log(GBIF native range)"~km^2), paste("ida_wcvp-vs-gbif_native_", today, ".png", sep = ""))

ida_wcvp_vs_gbif_all = my_ggplot_wrap_line(alldiv, "log10(wcvp_all_area)", "log10(gbif_all_area)", expression("log(WCVP full range)"~km^2), expression("log(GBIF full range)"~km^2), paste("ida_wcvp-vs-gbif_all_", today, ".png", sep = ""))

ida_wcvp_all_vs_wcvp_native = my_ggplot_wrap_line(alldiv, "log10(wcvp_all_area)", "log10(wcvp_native_area)", expression("log(WCVP full range)"~km^2), expression("log(WCVP native range)"~km^2), paste("ida_wcvp-all-vs-wcvp-native_", today, ".png", sep = ""))

ida_gbif_all_vs_gbif_native = my_ggplot_wrap_line(alldiv, "log10(gbif_all_area)", "log10(gbif_native_area)", expression("log(GBIF full range)"~km^2), expression("log(GBIF native range)"~km^2), paste("ida_gbif-all-vs-gbif-native_", today, ".png", sep = ""))

# plot diversity by mating system
ida_mating_vs_pi = my_ggplot_wrap_box(alldiv, "Mating.system", "log10(pi)", "Mating system", "log10(Nucleotide diversity)", paste("mating_vs_pi_", today, ".png", sep = ""))

ida_mating_vs_jac = my_ggplot_wrap_box(alldiv, "Mating.system", "jac", "Mating system", "Jaccard dissimilarity", paste("mating_vs_jac_", today, ".png", sep = ""))

ida_mating_vs_bcd = my_ggplot_wrap_box(alldiv, "Mating.system", "bcd", "Mating system", "Bray-Curtis dissimilarity", paste("mating_vs_bcd_", today, ".png", sep = ""))

# plot diversity by ploidy
ida_ploidy_vs_pi = my_ggplot_wrap_box(alldiv, "Ploidy", "log10(pi)", "Ploidy", "log10(Nucleotide diversity)", paste("ploidy_vs_pi_", today, ".png", sep = ""))

ida_ploidy_vs_jac = my_ggplot_wrap_box(alldiv, "Ploidy", "jac", "Ploidy", "Jaccard dissimilarity", paste("ploidy_vs_jac_", today, ".png", sep = ""))

ida_ploidy_vs_bcd = my_ggplot_wrap_box(alldiv, "Ploidy", "bcd", "Ploidy", "Bray-Curtis dissimilarity", paste("ploidy_vs_bcd_", today, ".png", sep = ""))

# plot diversity by cultivation status
ida_cult_vs_pi = my_ggplot_wrap_box(alldiv, "cultivation.status", "log10(pi)", "Cultivation status", "log10(Nucleotide diversity)", paste("cultivation_vs_pi_", today, ".png", sep = ""))

ida_cult_vs_jac = my_ggplot_wrap_box(alldiv, "cultivation.status", "jac", "Cultivation status", "Jaccard dissimilarity", paste("cultivation_vs_jac_", today, ".png", sep = ""))

ida_cult_vs_bcd = my_ggplot_wrap_box(alldiv, "cultivation.status", "bcd", "Cultivation status", "Bray-Curtis dissimilarity", paste("cultivation_vs_bcd_", today, ".png", sep = ""))

# plot height for each species, from tallest to shortest
#species_order = alldiv$species[sort(alldiv$height_final, decreasing = T, index.return = T)$ix]

#ggplot(alldiv, aes(x = species, y = height_final)) +
#  geom_bar(stat = "identity") +
#  theme_classic() +
#  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
#  scale_x_discrete(limits = species_order) + 
#  labs(x = "Species", y = "Height (m)")

#ggsave(paste("ida_height-by-species_", today, ".png", sep = ""), width = 16, height = 4.5, units = "in")
```


## distributions of variables
```{r eval=FALSE, include=FALSE}
# histograms of diversity data
ggplot(alldiv, aes(x = log10(pi))) +
  geom_histogram() +
  theme_classic() +
  labs(x = "log10(Nucleotide diversity)")

ggplot(alldiv, aes(x = jac)) +
  geom_histogram() +
  theme_classic() +
  labs(x = "Jaccard Dissimilarity")

ggplot(alldiv, aes(x = bcd)) +
  geom_histogram() +
  theme_classic() +
  labs(x = "Bray-Curtis Dissimilarity")
```

## correlations between variables
```{r}
# Does pi correlate with k-mer diversity?
cor(alldiv$pi, alldiv$bcd, method = "spearman", use = "pairwise.complete.obs")
cor(alldiv$pi, alldiv$jac, method = "spearman", use = "pairwise.complete.obs")

# Does k-mer diversity correlate with population size (i.e. range area) more than pi?
cor(alldiv$pi, alldiv$rangeArea, method = "spearman", use = "pairwise.complete.obs")
cor(alldiv$bcd, alldiv$rangeArea, method = "spearman", use = "pairwise.complete.obs")
cor(alldiv$jac, alldiv$rangeArea, method = "spearman", use = "pairwise.complete.obs")

cor(alldiv$pi, alldiv$area, method = "spearman", use = "pairwise.complete.obs")
cor(alldiv$bcd, alldiv$area, method = "spearman", use = "pairwise.complete.obs")
cor(alldiv$jac, alldiv$area, method = "spearman", use = "pairwise.complete.obs")

# How does the number of individuals correlate with the diversity measures
# More individuals = more opportunities to discover variants
cor(alldiv$pi, alldiv$nidv)
cor(alldiv$bcd, alldiv$nidv)
cor(alldiv$jac, alldiv$nidv)

# Correlations between population size and diversity, not-corrected for phylogeny
cor(alldiv$pi, alldiv$popsize, method = "spearman", use = "pairwise.complete.obs")
cor(alldiv$bcd, alldiv$popsize, method = "spearman", use = "pairwise.complete.obs")
```

# Confirmatory data analysis

## remove outliers before analysis
```{r}
# For now, remove species where invariant sites were not properly called
#alldiv = alldiv[(alldiv$ninvariant > 0),]

# For now, remove species where variants sites were not properly called
#alldiv = alldiv[(alldiv$nvariant > 100),]

# remove critically endangered species
# alldiv = alldiv[(alldiv$rangeArea > 10),]

# remove species where there aren't many sampled individuals
#alldiv = alldiv[(alldiv$nidv >= 5),]

# remove any rows that are NA for some reason
#alldiv = alldiv[!is.na(alldiv$species),]

# remove all species with <1.5x coverage on average across individuals
#subdiv = alldiv[(log10(alldiv$meancov) > log10(1.5)),]
#subdiv = alldiv[(log10(alldiv$meancov) > log10(1.5) | alldiv$nvariant >= 1000),]
subdiv = alldiv[(alldiv$nvariant >= 1000 & alldiv$meancov > 0.5),]
#subdiv = subdiv[(subdiv$species != "Brassica rapa"),] # omit other outlier species
```

## replot trends
```{r}
my_ggplot_wrap(subdiv, "log10(meancov)", "log10(pi)", "log10(mean coverage)", "log10(Nucleotide diversity)", paste("cda_coverage-vs-pi_", today, ".png", sep = ""))

my_ggplot_wrap(subdiv, "log10(meancov)", "jac", "log10(mean coverage)", "Jaccard dissimilarity", paste("cda_coverage-vs-jac_", today, ".png", sep = ""))

my_ggplot_wrap(subdiv, "log10(meancov)", "bcd", "log10(mean coverage)", "Bray-Curtis dissimilarity", paste("cda_coverage-vs-bcd_", today, ".png", sep = ""))

my_ggplot_wrap(subdiv, "cvbp", "log10(pi)", "Coeff. of variation in bp sequenced", "log10(Nucleotide diversity)", paste("cda_cvbp-vs-pi_", today, ".png", sep = ""))

my_ggplot_wrap(subdiv, "cvbp", "jac", "Coeff. of variation in bp sequenced", "Jaccard dissimilarity", paste("cda_cvbp-vs-jac_", today, ".png", sep = ""))

my_ggplot_wrap(subdiv, "cvbp", "bcd", "Coeff. of variation in bp sequenced", "Bray-Curtis dissimilarity", paste("cda_cvbp-vs-bcd_", today, ".png", sep = ""))

cda_pi_vs_jac = my_ggplot_wrap_xyz(subdiv, "log10(pi)", "jac", "log(Nucleotide diversity)", "Jaccard dissimilarity", paste("cda_pi-vs-jac_", today, ".png", sep = ""), "log10(meancov)", "#FEF2F2", "#190C64", "log(mean coverage)", c(min(log10(alldiv$meancov)), max(log10(alldiv$meancov))))

cda_pi_vs_bcd = my_ggplot_wrap_xyz(subdiv, "log10(pi)", "bcd", "log(Nucleotide diversity)", "Bray-Curtis dissimilarity", paste("cda_pi-vs-bcd_", today, ".png", sep = ""), "log10(meancov)", "#FEF2F2", "#190C64", "log(mean coverage)", c(min(log10(alldiv$meancov)), max(log10(alldiv$meancov))))

my_ggplot_wrap(subdiv, "jac", "bcd", "Jaccard dissimilarity", "Bray-Curtis dissimilarity", paste("cda_jac-vs-bcd_", today, ".png", sep = ""))

# compare population size proxies with diversity
cda_pi_vs_wcvp = my_ggplot_wrap(subdiv, "log10(pi)", "log10(wcvp_native_popsize)", "log(Nucleotide diversity)", "log(WCVP native ratio)", paste("cda_pi-vs-wcvp_", today, ".png", sep = ""))

cda_pi_vs_gbif = my_ggplot_wrap(subdiv, "log10(pi)", "log10(gbif_native_popsize)", "log(Nucleotide diversity)", "log(GBIF native ratio)", paste("cda_pi-vs-gbif_", today, ".png", sep = ""))

cda_jac_vs_wcvp = my_ggplot_wrap(subdiv, "jac", "log10(wcvp_native_popsize)", "Jaccard dissimilarity", "log(WCVP native ratio)", paste("cda_jac-vs-wcvp_", today, ".png", sep = ""))

cda_jac_vs_gbif = my_ggplot_wrap(subdiv, "jac", "log10(gbif_native_popsize)", "Jaccard dissimilarity", "log(GBIF native ratio)", paste("cda_jac-vs-gbif_", today, ".png", sep = ""))

cda_bcd_vs_wcvp = my_ggplot_wrap(subdiv, "bcd", "log10(wcvp_native_popsize)", "Bray-Curtis dissimilarity", "log(WCVP native ratio)", paste("cda_bcd-vs-wcvp_", today, ".png", sep = ""))

cda_bcd_vs_gbif = my_ggplot_wrap(subdiv, "bcd", "log10(gbif_native_popsize)", "Bray-Curtis dissimilarity", "log10(GBIF native ratio)", paste("cda_bcd-vs-gbif_", today, ".png", sep = ""))
```

## Combine tree and data to get comparative object
```{r}
# create comparative data object for caper models
# keep GBIF data separate from WCVP because GBIF might have missing values
compdata = comparative.data(phy, subdiv[,c("species","pi", "jac", "bcd", "genome.size", "meancov", "nidv", "cvbp", "cultivation.status", "Mating.system", "Generation.time","wcvp_native_popsize", "wcvp_all_popsize", "wcvp_native_area", "wcvp_all_area", "gbif_native_popsize", "gbif_all_popsize", "gbif_native_area", "gbif_all_area", "height_final")], names.col = "species", vcv = T)

#gbif_compdata = comparative.data(phy, subdiv[,c("species","pi", "jac", "bcd", "genome.size", "meancov", "nidv", "cvbp", "cultivation.status", "Mating.system", "gbif_native_popsize", "gbif_all_popsize", "gbif_native_area", "gbif_all_area")], names.col = "species", vcv = T)
```

## fit models

### population size vs diversity

```{r}
# check for multicollinarity before fitting models
#cor(wcvp_compdata$data[,c(-1, -8, -9)], method = "spearman", use = "pairwise.complete.obs")

##############################WCVP native population size vs diversity###################
mod_wcvp_native_popsize_pi = pgls(scale(log10(pi)) ~ log10(wcvp_native_popsize) + Mating.system + cultivation.status + Generation.time, compdata)
#summary(mod_wcvp_native_popsize_pi)
#plot(mod_wcvp_native_popsize_pi)

mod_wcvp_native_popsize_jac = pgls(scale(jac) ~ log10(wcvp_native_popsize) + Mating.system + cultivation.status + Generation.time, compdata)
#summary(mod_wcvp_native_popsize_jac)
#plot(mod_wcvp_native_popsize_jac)

mod_wcvp_native_popsize_bcd = pgls(scale(bcd) ~ log10(wcvp_native_popsize) + Mating.system + cultivation.status + Generation.time, compdata)
#summary(mod_wcvp_native_popsize_bcd)
#plot(mod_wcvp_native_popsize_bcd)

##############################WCVP all population size vs diversity######################

mod_wcvp_all_popsize_pi = pgls(scale(log10(pi)) ~ log10(wcvp_all_popsize) + Mating.system + cultivation.status + Generation.time, compdata)
#summary(mod_wcvp_all_popsize_pi)
#plot(mod_wcvp_all_popsize_pi)

mod_wcvp_all_popsize_jac = pgls(scale(jac) ~ log10(wcvp_all_popsize) + Mating.system + cultivation.status + Generation.time, compdata)
#summary(mod_wcvp_all_popsize_jac)
#plot(mod_wcvp_all_popsize_jac)

mod_wcvp_all_popsize_bcd = pgls(scale(bcd) ~ log10(wcvp_all_popsize) + Mating.system + cultivation.status + Generation.time, compdata)
#summary(mod_wcvp_all_popsize_bcd)
#plot(mod_wcvp_all_popsize_bcd)

############################GBIF native population size vs diversity####################

mod_gbif_native_popsize_pi = pgls(scale(log10(pi)) ~ log10(gbif_native_popsize) + Mating.system + cultivation.status + Generation.time, compdata)
#summary(mod_gbif_native_popsize_pi)

mod_gbif_native_popsize_jac = pgls(scale(jac) ~ log10(gbif_native_popsize) + Mating.system + cultivation.status + Generation.time, compdata)
#summary(mod_gbif_native_popsize_jac)

mod_gbif_native_popsize_bcd = pgls(scale(bcd) ~ log10(gbif_native_popsize) + Mating.system + cultivation.status + Generation.time, compdata)
#summary(mod_gbif_native_popsize_bcd)

##########################GBIF all population size vs diversity##########################

mod_gbif_all_popsize_pi = pgls(scale(log10(pi)) ~ log10(gbif_all_popsize) + Mating.system + cultivation.status + Generation.time, compdata)
#summary(mod_gbif_all_popsize_pi)

mod_gbif_all_popsize_jac = pgls(scale(jac) ~ log10(gbif_all_popsize) + Mating.system + cultivation.status + Generation.time, compdata)
#summary(mod_gbif_all_popsize_jac)

mod_gbif_all_popsize_bcd = pgls(scale(bcd) ~ log10(gbif_all_popsize) + Mating.system + cultivation.status + Generation.time, compdata)
#summary(mod_gbif_all_popsize_bcd)

####WCVP all range size vs diversity####
mod_wcvp_all_area_pi = pgls(scale(log10(pi)) ~ log10(wcvp_all_area) + Mating.system + cultivation.status + Generation.time, compdata)

mod_wcvp_all_area_jac = pgls(scale(jac) ~ log10(wcvp_all_area) + Mating.system + cultivation.status + Generation.time, compdata)

mod_wcvp_all_area_bcd = pgls(scale(bcd) ~ log10(wcvp_all_area) + Mating.system + cultivation.status + Generation.time, compdata)

####WCVP native range size vs diversity####
mod_wcvp_native_area_pi = pgls(scale(log10(pi)) ~ log10(wcvp_native_area) + Mating.system + cultivation.status + Generation.time, compdata)

mod_wcvp_native_area_jac = pgls(scale(jac) ~ log10(wcvp_native_area) + Mating.system + cultivation.status + Generation.time, compdata)

mod_wcvp_native_area_bcd = pgls(scale(bcd) ~ log10(wcvp_native_area) + Mating.system + cultivation.status + Generation.time, compdata)

####GBIF all range size vs diversity####
mod_gbif_all_area_pi = pgls(scale(log10(pi)) ~ log10(gbif_all_area) + Mating.system + cultivation.status + Generation.time, compdata)

mod_gbif_all_area_jac = pgls(scale(jac) ~ log10(gbif_all_area) + Mating.system + cultivation.status + Generation.time, compdata)

mod_gbif_all_area_bcd = pgls(scale(bcd) ~ log10(gbif_all_area) + Mating.system + cultivation.status + Generation.time, compdata)

####GBIF native range size vs diversity####
mod_gbif_native_area_pi = pgls(scale(log10(pi)) ~ log10(gbif_native_area) + Mating.system + cultivation.status + Generation.time, compdata)

mod_gbif_native_area_jac = pgls(scale(jac) ~ log10(gbif_native_area) + Mating.system + cultivation.status + Generation.time, compdata)

mod_gbif_native_area_bcd = pgls(scale(bcd) ~ log10(gbif_native_area) + Mating.system + cultivation.status + Generation.time, compdata)

####plant height vs diversity####
mod_height_pi = pgls(scale(log10(pi)) ~ log10(height_final) + Mating.system + cultivation.status + Generation.time, compdata)

mod_height_jac = pgls(scale(jac) ~ log10(height_final) + Mating.system + cultivation.status + Generation.time, compdata)

mod_height_bcd = pgls(scale(bcd) ~ log10(height_final) + Mating.system + cultivation.status + Generation.time, compdata)

# create model matrices for plotting multiple regressions
mod_mat_wcvp_native = model.matrix(~ log10(wcvp_native_popsize) + Mating.system + cultivation.status + Generation.time, data = compdata$data)

mod_mat_wcvp_all = model.matrix(~ log10(wcvp_all_popsize) + Mating.system + cultivation.status + Generation.time, data = compdata$data)

mod_mat_gbif_native = model.matrix(~ log10(gbif_native_popsize) + Mating.system + cultivation.status + Generation.time, data = compdata$data)

mod_mat_gbif_all = model.matrix(~ log10(gbif_all_popsize) + Mating.system + cultivation.status + Generation.time, data = compdata$data)

mod_mat_wcvp_native_area = model.matrix(~ log10(wcvp_native_area) + Mating.system + cultivation.status + Generation.time, data = compdata$data)

mod_mat_wcvp_all_area = model.matrix(~ log10(wcvp_all_area) + Mating.system + cultivation.status + Generation.time, data = compdata$data)

mod_mat_gbif_native_area = model.matrix(~ log10(gbif_native_area) + Mating.system + cultivation.status + Generation.time, data = compdata$data)

mod_mat_gbif_all_area = model.matrix(~ log10(gbif_all_area) + Mating.system + cultivation.status + Generation.time, data = compdata$data)

mod_mat_height = model.matrix(~ log10(height_final) + Mating.system + cultivation.status + Generation.time, data = compdata$data)

####Plot multiple regressions####

# function to perform phylogenetic least squares, adjust for covariates, and plot primary variable against responses
correct_and_plot = function(mod_mat, y, V, primary, xlab, ylab, xpos, ypos){
  # Get cholesky decomposition of variance covariance matrix
  # then invert the matrix
  # then transpose it
  C_inv = t(solve(chol(V)))
  
  # scale data by phylogenetic effect
  # This translates the generalized least squares model into an ordinary least squares model
  y_star = C_inv %*% y
  X_star = C_inv %*% mod_mat
  
  # perform ordinary least squares regression
  # omit intercept because it's included in design matrix
  mod_star = lm(y_star ~ X_star - 1)
  coeff_star = coefficients(mod_star)
  
  names(coeff_star) = gsub("^X_star", "", names(coeff_star)) # remove new names from coefficients
  
  # extract p-value for slope of primary variable
  pvalues = summary(mod_star)$coefficients
  rownames(pvalues) = gsub("^X_star", "", rownames(pvalues)) # remove new names from coefficients
  slope_value = signif(pvalues[primary,1], digits = 2) # get slope
  slope_se_value = signif(pvalues[primary,2], digits = 2) # get standard error of slope
  slope_p_value = signif(pvalues[primary,4], digits = 2) # get p-value for slope
  adj_r_squared = signif(summary(mod_star)$adj.r.squared, digits = 2) # get adjusted R-squared for whole model
  
  # correct response for phylogeny and other covariates, then plot against predictor of interest
  technicals = colnames(X_star)[(colnames(X_star) != primary)]
  y_star_corrected = y_star - (X_star[,technicals] %*% coeff_star[technicals])
  
  # Create label that will go on plot with lm information
  modlabel = paste("slope = ", slope_value, " +/- ", slope_se_value, "\n", "p = ", slope_p_value, "\n", "Adj. R^2 = ", adj_r_squared, sep = "")
  
  # plot result
  myplot = ggplot(mapping = aes(x = X_star[,primary], y = y_star_corrected)) +
    geom_point() +
    geom_abline(intercept = 0, slope = coeff_star[primary], color = "purple") +
    theme_classic() +
    theme(text = element_text(size = 10)) +
    #stat_regline_equation(aes(label = paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")), size = 5) +
    #annotate(geom = "text", x = xpos, y = ypos, label = modlabel, size = 7) +
    ggtitle(modlabel) +
    labs(x = xlab, y = ylab)
  
  #print(X_star[,primary])
    
  return(myplot)
}

# create plots, save to objects

## wcvp

wcvp_native_vs_pi_corrected = correct_and_plot(mod_mat_wcvp_native, mod_wcvp_native_popsize_pi$y, mod_wcvp_native_popsize_pi$Vt, "log10(wcvp_native_popsize)", "log(WCVP native ratio), adj.", "log(Nucleotide diversity), adj.")

wcvp_all_vs_pi_corrected = correct_and_plot(mod_mat_wcvp_all, mod_wcvp_all_popsize_pi$y, mod_wcvp_all_popsize_pi$Vt, "log10(wcvp_all_popsize)", "log(WCVP full ratio), adj.", "log(Nucleotide diversity), adj.")

wcvp_all_area_vs_pi_corrected = correct_and_plot(mod_mat_wcvp_all_area, mod_wcvp_all_area_pi$y, mod_wcvp_all_area_pi$Vt, "log10(wcvp_all_area)", "log(WCVP full range), adj.", "log(Nucleotide diversity), adj.")

wcvp_native_area_vs_pi_corrected = correct_and_plot(mod_mat_wcvp_native_area, mod_wcvp_native_area_pi$y, mod_wcvp_native_area_pi$Vt, "log10(wcvp_native_area)", "log(WCVP native range), adj.", "log(Nucleotide diversity), adj.")

wcvp_native_vs_jac_corrected = correct_and_plot(mod_mat_wcvp_native, mod_wcvp_native_popsize_jac$y, mod_wcvp_native_popsize_jac$Vt, "log10(wcvp_native_popsize)", "log(WCVP native ratio), adj.", "Jaccard dissimilarity, adj.")

wcvp_all_vs_jac_corrected = correct_and_plot(mod_mat_wcvp_all, mod_wcvp_all_popsize_jac$y, mod_wcvp_all_popsize_jac$Vt, "log10(wcvp_all_popsize)", "log(WCVP full ratio), adj.", "Jaccard dissimilarity, adj.")

wcvp_all_area_vs_jac_corrected = correct_and_plot(mod_mat_wcvp_all_area, mod_wcvp_all_area_jac$y, mod_wcvp_all_area_jac$Vt, "log10(wcvp_all_area)", "log(WCVP full range), adj.", "Jaccard dissimilarity, adj.")

wcvp_native_area_vs_jac_corrected = correct_and_plot(mod_mat_wcvp_native_area, mod_wcvp_native_area_jac$y, mod_wcvp_native_area_jac$Vt, "log10(wcvp_native_area)", "log(WCVP native range), adj.", "Jaccard dissimilarity, adj.")

wcvp_native_vs_bcd_corrected = correct_and_plot(mod_mat_wcvp_native, mod_wcvp_native_popsize_bcd$y, mod_wcvp_native_popsize_bcd$Vt, "log10(wcvp_native_popsize)", "log(WCVP native ratio), adj.", "Bray-Curtis dissimilarity, adj.")

wcvp_all_vs_bcd_corrected = correct_and_plot(mod_mat_wcvp_all, mod_wcvp_all_popsize_bcd$y, mod_wcvp_all_popsize_bcd$Vt, "log10(wcvp_all_popsize)", "log(WCVP full ratio), adj.", "Bray-Curtis dissimilarity, adj.")

wcvp_all_area_vs_bcd_corrected = correct_and_plot(mod_mat_wcvp_all_area, mod_wcvp_all_area_bcd$y, mod_wcvp_all_area_bcd$Vt, "log10(wcvp_all_area)", "log(WCVP full range), adj.", "Bray-Curtis dissimilarity, adj.")

wcvp_native_area_vs_bcd_corrected = correct_and_plot(mod_mat_wcvp_native_area, mod_wcvp_native_area_bcd$y, mod_wcvp_native_area_bcd$Vt, "log10(wcvp_native_area)", "log(WCVP native range, km^2), adj.", "Bray-Curtis dissimilarity, adj.")

## gbif

# pi

gbif_native_vs_pi_corrected = correct_and_plot(mod_mat_gbif_native, mod_gbif_native_popsize_pi$y, mod_gbif_native_popsize_pi$Vt, "log10(gbif_native_popsize)", "log(GBIF native ratio), adj.", "log(Nucleotide diversity), adj.")

gbif_all_vs_pi_corrected = correct_and_plot(mod_mat_gbif_all, mod_gbif_all_popsize_pi$y, mod_gbif_all_popsize_pi$Vt, "log10(gbif_all_popsize)", "log(GBIF full ratio), adj.", "log(Nucleotide diversity), adj.")

gbif_all_area_vs_pi_corrected = correct_and_plot(mod_mat_gbif_all_area, mod_gbif_all_area_pi$y, mod_gbif_all_area_pi$Vt, "log10(gbif_all_area)", "log(GBIF full range, km^2), adj.", "log(Nucleotide diversity), adj.")
  
gbif_native_area_vs_pi_corrected = correct_and_plot(mod_mat_gbif_native_area, mod_gbif_native_area_pi$y, mod_gbif_native_area_pi$Vt, "log10(gbif_native_area)", "log(GBIF native range, km^2), adj.", "log(Nucleotide diversity), adj.")

# JAC

gbif_native_vs_jac_corrected = correct_and_plot(mod_mat_gbif_native, mod_gbif_native_popsize_jac$y, mod_gbif_native_popsize_jac$Vt, "log10(gbif_native_popsize)", "log(GBIF native ratio), adj.", "Jaccard dissimilarity, adj.")

gbif_all_vs_jac_corrected = correct_and_plot(mod_mat_gbif_all, mod_gbif_all_popsize_jac$y, mod_gbif_all_popsize_jac$Vt, "log10(gbif_all_popsize)", "log(GBIF full ratio), adj.", "Jaccard dissimilarity, adj.")

gbif_all_area_vs_jac_corrected = correct_and_plot(mod_mat_gbif_all_area, mod_gbif_all_area_jac$y, mod_gbif_all_area_jac$Vt, "log10(gbif_all_area)", "log(GBIF full range, km^2), adj.", "Jaccard dissimilarity, adj.")
  
gbif_native_area_vs_jac_corrected = correct_and_plot(mod_mat_gbif_native_area, mod_gbif_native_area_jac$y, mod_gbif_native_area_jac$Vt, "log10(gbif_native_area)", "log(GBIF native range, km^2), adj.", "Jaccard dissimilarity, adj.")

# bcd

gbif_native_vs_bcd_corrected = correct_and_plot(mod_mat_gbif_native, mod_gbif_native_popsize_bcd$y, mod_gbif_native_popsize_bcd$Vt, "log10(gbif_native_popsize)", "log(GBIF native ratio), adj.", "Bray-Curtis dissimilarity, adj.")

gbif_all_vs_bcd_corrected = correct_and_plot(mod_mat_gbif_all, mod_gbif_all_popsize_bcd$y, mod_gbif_all_popsize_bcd$Vt, "log10(gbif_all_popsize)", "log(GBIF full ratio), adj.", "Bray-Curtis dissimilarity, adj.")

gbif_all_area_vs_bcd_corrected = correct_and_plot(mod_mat_gbif_all_area, mod_gbif_all_area_bcd$y, mod_gbif_all_area_bcd$Vt, "log10(gbif_all_area)", "log(GBIF full range, km^2), adj.", "Bray-Curtis dissimilarity, adj.")
  
gbif_native_area_vs_bcd_corrected = correct_and_plot(mod_mat_gbif_native_area, mod_gbif_native_area_bcd$y, mod_gbif_native_area_bcd$Vt, "log10(gbif_native_area)", "log(GBIF native range, km^2), adj.", "Bray-Curtis dissimilarity, adj.")

## height

height_vs_pi_corrected = correct_and_plot(mod_mat_height, mod_height_pi$y, mod_height_pi$Vt, "log10(height_final)", "log(height, m), adj.", "log(Nucleotide diversity), adj.")

height_vs_jac_corrected = correct_and_plot(mod_mat_height, mod_height_jac$y, mod_height_jac$Vt, "log10(height_final)", "log(height, m), adj.", "Jaccard dissimilarity, adj.")

height_vs_bcd_corrected = correct_and_plot(mod_mat_height, mod_height_bcd$y, mod_height_bcd$Vt, "log10(height_final)", "log(height, m), adj.", "Jaccard dissimilarity, adj.")


#wcvp_pop_vs_pi_corrected = correct_and_plot(mod_mat_wcvp_pop_vs_pi, mod_pi_1$y, mod_pi_1$Vt, "log10(wcvp_native_popsize)", "log10(WCVP pop size ratio), scaled", "log10(Nucleotide diversity), scaled and adjusted")

#wcvp_pop_vs_jac_corrected = correct_and_plot(mod_mat_wcvp_pop_vs_jac, mod_jac_1$y, mod_jac_1$Vt, "log10(wcvp_native_popsize)", "log10(WCVP pop size ratio), scaled", "Jaccard dissimilarity, scaled and adjusted")

#wcvp_pop_vs_bcd_corrected = correct_and_plot(mod_mat_wcvp_pop_vs_bcd, mod_bcd_1$y, mod_bcd_1$Vt, "log10(wcvp_native_popsize)", "log10(WCVP pop size ratio), scaled", "Bray-Curtis dissimilarity, scaled and adjusted")

#wcvp_area_vs_pi_corrected = correct_and_plot(mod_mat_wcvp_area_vs_pi, mod_pi_wcvp_area_3$y, mod_pi_wcvp_area_3$Vt, "log10(area)", "log10(WCVP range in square km), scaled", "log10(Nucleotide diversity), scaled and adjusted")

#wcvp_area_vs_jac_corrected = correct_and_plot(mod_mat_wcvp_area_vs_jac, mod_jac_wcvp_area_1$y, mod_jac_wcvp_area_1$Vt, "log10(area)", "log10(WCVP range in square km), scaled", "Jaccard dissimilarity, scaled and adjusted")

#wcvp_area_vs_bcd_corrected = correct_and_plot(mod_mat_wcvp_area_vs_bcd, mod_bcd_wcvp_area_2$y, mod_bcd_wcvp_area_2$Vt, "log10(area)", "log10(WCVP range in square km), scaled", "Bray-Curtis dissimilarity, scaled and adjusted")

```

### Genome size vs diversity
```{r}
# WCVP

## native + invaded ratio
genome_wcvp_all_vs_pi = pgls(scale(log10(pi)) ~ log10(genome.size) + log10(wcvp_all_popsize) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_wcvp_all_vs_pi)
#plot(genome_wcvp_all_vs_pi)

genome_wcvp_all_vs_jac = pgls(scale(jac) ~ log10(genome.size) + log10(wcvp_all_popsize) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_wcvp_all_vs_jac)

genome_wcvp_all_vs_bcd = pgls(scale(bcd) ~ log10(genome.size) + log10(wcvp_all_popsize) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_wcvp_all_vs_bcd)

genome_mod_mat_wcvp_all = model.matrix(~ log10(genome.size) + log10(wcvp_all_popsize) + Mating.system + Generation.time + cultivation.status, data = compdata$data)

## native only ratio
genome_wcvp_native_vs_pi = pgls(scale(log10(pi)) ~ log10(genome.size) + log10(wcvp_native_popsize) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_wcvp_native_vs_pi)

genome_wcvp_native_vs_jac = pgls(scale(jac) ~ log10(genome.size) + log10(wcvp_native_popsize) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_wcvp_native_vs_jac)

genome_wcvp_native_vs_bcd = pgls(scale(bcd) ~ log10(genome.size) + log10(wcvp_native_popsize) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_wcvp_native_vs_bcd)

genome_mod_mat_wcvp_native = model.matrix(~ log10(genome.size) + log10(wcvp_native_popsize) + Mating.system + Generation.time + cultivation.status, data = compdata$data)

## native + invaded range size
genome_wcvp_all_area_vs_pi = pgls(scale(log10(pi)) ~ log10(genome.size) + log10(wcvp_all_area) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_wcvp_all_area_vs_pi)

genome_wcvp_all_area_vs_jac = pgls(scale(jac) ~ log10(genome.size) + log10(wcvp_all_area) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_wcvp_all_area_vs_jac)

genome_wcvp_all_area_vs_bcd = pgls(scale(bcd) ~ log10(genome.size) + log10(wcvp_all_area) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_wcvp_all_area_vs_bcd)

genome_mod_mat_wcvp_all_area = model.matrix(~ log10(genome.size) + log10(wcvp_all_area) + Mating.system + Generation.time + cultivation.status, data = compdata$data)

## native range size
genome_wcvp_native_area_vs_pi = pgls(scale(log10(pi)) ~ log10(genome.size) + log10(wcvp_native_area) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_wcvp_native_area_vs_pi)

genome_wcvp_native_area_vs_jac = pgls(scale(jac) ~ log10(genome.size) + log10(wcvp_native_area) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_wcvp_native_area_vs_jac)

genome_wcvp_native_area_vs_bcd = pgls(scale(bcd) ~ log10(genome.size) + log10(wcvp_native_area) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_wcvp_native_area_vs_bcd)

genome_mod_mat_wcvp_native_area = model.matrix(~ log10(genome.size) + log10(wcvp_native_area) + Mating.system + Generation.time + cultivation.status, data = compdata$data)

# GBIF

## native + invaded ratio
genome_gbif_all_vs_pi = pgls(scale(log10(pi)) ~ log10(genome.size) + log10(gbif_all_popsize) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_gbif_all_vs_pi)

genome_gbif_all_vs_jac = pgls(scale(jac) ~ log10(genome.size) + log10(gbif_all_popsize) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_gbif_all_vs_jac)

genome_gbif_all_vs_bcd = pgls(scale(bcd) ~ log10(genome.size) + log10(gbif_all_popsize) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_gbif_all_vs_bcd)

genome_mod_mat_gbif_all = model.matrix(~ log10(genome.size) + log10(gbif_all_popsize) + Mating.system + Generation.time + cultivation.status, data = compdata$data)

## native only ratio
genome_gbif_native_vs_pi = pgls(scale(log10(pi)) ~ log10(genome.size) + log10(gbif_native_popsize) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_gbif_native_vs_pi)

genome_gbif_native_vs_jac = pgls(scale(jac) ~ log10(genome.size) + log10(gbif_native_popsize) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_gbif_native_vs_jac)

genome_gbif_native_vs_bcd = pgls(scale(bcd) ~ log10(genome.size) + log10(gbif_native_popsize) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_gbif_native_vs_bcd)

genome_mod_mat_gbif_native = model.matrix(~ log10(genome.size) + log10(gbif_native_popsize) + Mating.system + Generation.time + cultivation.status, data = compdata$data)

## native + invaded range size
genome_gbif_all_area_vs_pi = pgls(scale(log10(pi)) ~ log10(genome.size) + log10(gbif_all_area) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_gbif_all_area_vs_pi)

genome_gbif_all_area_vs_jac = pgls(scale(jac) ~ log10(genome.size) + log10(gbif_all_area) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_gbif_all_area_vs_jac)

genome_gbif_all_area_vs_bcd = pgls(scale(bcd) ~ log10(genome.size) + log10(gbif_all_area) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_gbif_all_area_vs_bcd)

genome_mod_mat_gbif_all_area = model.matrix(~ log10(genome.size) + log10(gbif_all_area) + Mating.system + Generation.time + cultivation.status, data = compdata$data)

## native range size
genome_gbif_native_area_vs_pi = pgls(scale(log10(pi)) ~ log10(genome.size) + log10(gbif_native_area) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_gbif_native_area_vs_pi)

genome_gbif_native_area_vs_jac = pgls(scale(jac) ~ log10(genome.size) + log10(gbif_native_area) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_gbif_native_area_vs_jac)

genome_gbif_native_area_vs_bcd = pgls(scale(bcd) ~ log10(genome.size) + log10(gbif_native_area) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_gbif_native_area_vs_bcd)

genome_mod_mat_gbif_native_area = model.matrix(~ log10(genome.size) + log10(gbif_native_area) + Mating.system + Generation.time + cultivation.status, data = compdata$data)

# height
genome_height_vs_pi = pgls(scale(log10(pi)) ~ log10(genome.size) + log10(height_final) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_height_vs_pi)

genome_height_vs_jac = pgls(scale(jac) ~ log10(genome.size) + log10(height_final) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_height_vs_jac)

genome_height_vs_bcd = pgls(scale(bcd) ~ log10(genome.size) + log10(height_final) + Mating.system + Generation.time + cultivation.status, data = compdata)
#summary(genome_height_vs_bcd)

genome_mod_mat_height = model.matrix(~ log10(genome.size) + log10(height_final) + Mating.system + Generation.time + cultivation.status, data = compdata$data)

# create plots

## gbif all ratio
genome_gbif_all_vs_pi_figure = correct_and_plot(genome_mod_mat_gbif_all, genome_gbif_all_vs_pi$y, genome_gbif_all_vs_pi$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "log(Nucleotide diversity), adj.")

genome_gbif_all_vs_jac_figure = correct_and_plot(genome_mod_mat_gbif_all, genome_gbif_all_vs_jac$y, genome_gbif_all_vs_jac$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "Jaccard dissimilarity, adj.")

genome_gbif_all_vs_bcd_figure = correct_and_plot(genome_mod_mat_gbif_all, genome_gbif_all_vs_bcd$y, genome_gbif_all_vs_bcd$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "Bray-Curtis dissimilarity, adj.")

## gbif native ratio
genome_gbif_native_vs_pi_figure = correct_and_plot(genome_mod_mat_gbif_native, genome_gbif_native_vs_pi$y, genome_gbif_native_vs_pi$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "log(Nucleotide diversity), adj.")

genome_gbif_native_vs_jac_figure = correct_and_plot(genome_mod_mat_gbif_native, genome_gbif_native_vs_jac$y, genome_gbif_native_vs_jac$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "Jaccard dissimilarity, adj.")

genome_gbif_native_vs_bcd_figure = correct_and_plot(genome_mod_mat_gbif_native, genome_gbif_native_vs_bcd$y, genome_gbif_native_vs_bcd$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "Bray-Curtis dissimilarity, adj.")

## gbif all range size
genome_gbif_all_area_vs_pi_figure = correct_and_plot(genome_mod_mat_gbif_all_area, genome_gbif_all_area_vs_pi$y, genome_gbif_all_area_vs_pi$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "log(Nucleotide diversity), adj.")

genome_gbif_all_area_vs_jac_figure = correct_and_plot(genome_mod_mat_gbif_all_area, genome_gbif_all_area_vs_jac$y, genome_gbif_all_area_vs_jac$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "Jaccard dissimilarity, adj.")

genome_gbif_all_area_vs_bcd_figure = correct_and_plot(genome_mod_mat_gbif_all_area, genome_gbif_all_area_vs_bcd$y, genome_gbif_all_area_vs_bcd$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "Bray-Curtis dissimilarity, adj.")

## gbif native range size
genome_gbif_native_area_vs_pi_figure = correct_and_plot(genome_mod_mat_gbif_native_area, genome_gbif_native_area_vs_pi$y, genome_gbif_native_area_vs_pi$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "log(Nucleotide diversity), adj.")

genome_gbif_native_area_vs_jac_figure = correct_and_plot(genome_mod_mat_gbif_native_area, genome_gbif_native_area_vs_jac$y, genome_gbif_native_area_vs_jac$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "Jaccard dissimilarity, adj.")

genome_gbif_native_area_vs_bcd_figure = correct_and_plot(genome_mod_mat_gbif_native_area, genome_gbif_native_area_vs_bcd$y, genome_gbif_native_area_vs_bcd$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "Bray-Curtis dissimilarity, adj.")

## wcvp all
genome_wcvp_all_vs_pi_figure = correct_and_plot(genome_mod_mat_wcvp_all, genome_wcvp_all_vs_pi$y, genome_wcvp_all_vs_pi$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "log(Nucleotide diversity), adj.")

genome_wcvp_all_vs_jac_figure = correct_and_plot(genome_mod_mat_wcvp_all, genome_wcvp_all_vs_jac$y, genome_wcvp_all_vs_jac$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "Jaccard dissimilarity, adj.")

genome_wcvp_all_vs_bcd_figure = correct_and_plot(genome_mod_mat_wcvp_all, genome_wcvp_all_vs_bcd$y, genome_wcvp_all_vs_bcd$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "Bray-Curtis dissimilarity, adj.")

## wcvp native
genome_wcvp_native_vs_pi_figure = correct_and_plot(genome_mod_mat_wcvp_native, genome_wcvp_native_vs_pi$y, genome_wcvp_native_vs_pi$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "log(Nucleotide diversity), adj.")

genome_wcvp_native_vs_jac_figure = correct_and_plot(genome_mod_mat_wcvp_native, genome_wcvp_native_vs_jac$y, genome_wcvp_native_vs_jac$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "Jaccard dissimilarity, adj.")

genome_wcvp_native_vs_bcd_figure = correct_and_plot(genome_mod_mat_wcvp_native, genome_wcvp_native_vs_bcd$y, genome_wcvp_native_vs_bcd$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "Bray-Curtis dissimilarity, adj.")

## wcvp all range size
genome_wcvp_all_area_vs_pi_figure = correct_and_plot(genome_mod_mat_wcvp_all_area, genome_wcvp_all_area_vs_pi$y, genome_wcvp_all_area_vs_pi$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "log(Nucleotide diversity), adj.")

genome_wcvp_all_area_vs_jac_figure = correct_and_plot(genome_mod_mat_wcvp_all_area, genome_wcvp_all_area_vs_jac$y, genome_wcvp_all_area_vs_jac$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "Jaccard dissimilarity, adj.")

genome_wcvp_all_area_vs_bcd_figure = correct_and_plot(genome_mod_mat_wcvp_all_area, genome_wcvp_all_area_vs_bcd$y, genome_wcvp_all_area_vs_bcd$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "Bray-Curtis dissimilarity, adj.")

## wcvp native range size
genome_wcvp_native_area_vs_pi_figure = correct_and_plot(genome_mod_mat_wcvp_native_area, genome_wcvp_native_area_vs_pi$y, genome_wcvp_native_area_vs_pi$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "log(Nucleotide diversity), adj.")

genome_wcvp_native_area_vs_jac_figure = correct_and_plot(genome_mod_mat_wcvp_native_area, genome_wcvp_native_area_vs_jac$y, genome_wcvp_native_area_vs_jac$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "Jaccard dissimilarity, adj.")

genome_wcvp_native_area_vs_bcd_figure = correct_and_plot(genome_mod_mat_wcvp_native_area, genome_wcvp_native_area_vs_bcd$y, genome_wcvp_native_area_vs_bcd$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "Bray-Curtis dissimilarity, adj.")

## height
genome_height_vs_pi_figure = correct_and_plot(genome_mod_mat_height, genome_height_vs_pi$y, genome_height_vs_pi$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "log(Nucleotide diversity), adj.")

genome_height_vs_jac_figure = correct_and_plot(genome_mod_mat_height, genome_height_vs_jac$y, genome_height_vs_jac$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "Jaccard dissimilarity, adj.")

genome_height_vs_bcd_figure = correct_and_plot(genome_mod_mat_height, genome_height_vs_bcd$y, genome_height_vs_bcd$Vt, "log10(genome.size)", "log(genome size in bp), adj.", "Bray-Curtis dissimilarity, adj.")
```

### Population size vs diversity, controlling for genome size
```{r}
## gbif all ratio
pop_genome_gbif_all_vs_pi_figure = correct_and_plot(genome_mod_mat_gbif_all, genome_gbif_all_vs_pi$y, genome_gbif_all_vs_pi$Vt, "log10(gbif_all_popsize)", "log(GBIF full ratio), adj.", "log(Nucleotide diversity), adj.")

pop_genome_gbif_all_vs_jac_figure = correct_and_plot(genome_mod_mat_gbif_all, genome_gbif_all_vs_jac$y, genome_gbif_all_vs_jac$Vt, "log10(gbif_all_popsize)", "log(GBIF full ratio), adj.", "Jaccard dissimilarity, adj.")

pop_genome_gbif_all_vs_bcd_figure = correct_and_plot(genome_mod_mat_gbif_all, genome_gbif_all_vs_bcd$y, genome_gbif_all_vs_bcd$Vt, "log10(gbif_all_popsize)", "log(GBIF full ratio), adj.", "Bray-Curtis dissimilarity, adj.")

## gbif native ratio
pop_genome_gbif_native_vs_pi_figure = correct_and_plot(genome_mod_mat_gbif_native, genome_gbif_native_vs_pi$y, genome_gbif_native_vs_pi$Vt, "log10(gbif_native_popsize)", "log(GBIF native ratio), adj.", "log(Nucleotide diversity), adj.")

pop_genome_gbif_native_vs_jac_figure = correct_and_plot(genome_mod_mat_gbif_native, genome_gbif_native_vs_jac$y, genome_gbif_native_vs_jac$Vt, "log10(gbif_native_popsize)", "log(GBIF native ratio), adj.", "Jaccard dissimilarity, adj.")

pop_genome_gbif_native_vs_bcd_figure = correct_and_plot(genome_mod_mat_gbif_native, genome_gbif_native_vs_bcd$y, genome_gbif_native_vs_bcd$Vt, "log10(gbif_native_popsize)", "log(GBIF native ratio), adj.", "Bray-Curtis dissimilarity, adj.")

## gbif all range size
pop_genome_gbif_all_area_vs_pi_figure = correct_and_plot(genome_mod_mat_gbif_all_area, genome_gbif_all_area_vs_pi$y, genome_gbif_all_area_vs_pi$Vt, "log10(gbif_all_area)", "log(GBIF full range, km^2), adj.", "log(Nucleotide diversity), adj.")

pop_genome_gbif_all_area_vs_jac_figure = correct_and_plot(genome_mod_mat_gbif_all_area, genome_gbif_all_area_vs_jac$y, genome_gbif_all_area_vs_jac$Vt, "log10(gbif_all_area)", "log(GBIF full range, km^2), adj.", "Jaccard dissimilarity, adj.")

pop_genome_gbif_all_area_vs_bcd_figure = correct_and_plot(genome_mod_mat_gbif_all_area, genome_gbif_all_area_vs_bcd$y, genome_gbif_all_area_vs_bcd$Vt, "log10(gbif_all_area)", "log(GBIF full range, km^2), adj.", "Bray-Curtis dissimilarity, adj.")

## gbif native range size
pop_genome_gbif_native_area_vs_pi_figure = correct_and_plot(genome_mod_mat_gbif_native_area, genome_gbif_native_area_vs_pi$y, genome_gbif_native_area_vs_pi$Vt, "log10(gbif_native_area)", "log(GBIF native range, km^2), adj.", "log(Nucleotide diversity), adj.")

pop_genome_gbif_native_area_vs_jac_figure = correct_and_plot(genome_mod_mat_gbif_native_area, genome_gbif_native_area_vs_jac$y, genome_gbif_native_area_vs_jac$Vt, "log10(gbif_native_area)", "log(GBIF native range, km^2), adj.", "Jaccard dissimilarity, adj.")

pop_genome_gbif_native_area_vs_bcd_figure = correct_and_plot(genome_mod_mat_gbif_native_area, genome_gbif_native_area_vs_bcd$y, genome_gbif_native_area_vs_bcd$Vt, "log10(gbif_native_area)", "log(GBIF native range, km^2), adj.", "Bray-Curtis dissimilarity, adj.")

## wcvp all
pop_genome_wcvp_all_vs_pi_figure = correct_and_plot(genome_mod_mat_wcvp_all, genome_wcvp_all_vs_pi$y, genome_wcvp_all_vs_pi$Vt, "log10(wcvp_all_popsize)", "log(WCVP full ratio), adj.", "log(Nucleotide diversity), adj.")

pop_genome_wcvp_all_vs_jac_figure = correct_and_plot(genome_mod_mat_wcvp_all, genome_wcvp_all_vs_jac$y, genome_wcvp_all_vs_jac$Vt, "log10(wcvp_all_popsize)", "log(WCVP full ratio), adj.", "Jaccard dissimilarity, adj.")

pop_genome_wcvp_all_vs_bcd_figure = correct_and_plot(genome_mod_mat_wcvp_all, genome_wcvp_all_vs_bcd$y, genome_wcvp_all_vs_bcd$Vt, "log10(wcvp_all_popsize)", "log(WCVP full ratio), adj.", "Bray-Curtis dissimilarity, adj.")

## wcvp native
pop_genome_wcvp_native_vs_pi_figure = correct_and_plot(genome_mod_mat_wcvp_native, genome_wcvp_native_vs_pi$y, genome_wcvp_native_vs_pi$Vt, "log10(wcvp_native_popsize)", "log(WCVP native ratio), adj.", "log(Nucleotide diversity), adj.")

pop_genome_wcvp_native_vs_jac_figure = correct_and_plot(genome_mod_mat_wcvp_native, genome_wcvp_native_vs_jac$y, genome_wcvp_native_vs_jac$Vt, "log10(wcvp_native_popsize)", "log(WCVP native ratio), adj.", "Jaccard dissimilarity, adj.")

pop_genome_wcvp_native_vs_bcd_figure = correct_and_plot(genome_mod_mat_wcvp_native, genome_wcvp_native_vs_bcd$y, genome_wcvp_native_vs_bcd$Vt, "log10(wcvp_native_popsize)", "log(WCVP native ratio), adj.", "Bray-Curtis dissimilarity, adj.")

## wcvp all range size
pop_genome_wcvp_all_area_vs_pi_figure = correct_and_plot(genome_mod_mat_wcvp_all_area, genome_wcvp_all_area_vs_pi$y, genome_wcvp_all_area_vs_pi$Vt, "log10(wcvp_all_area)", "log(WCVP full range, km^2), adj.", "log(Nucleotide diversity), adj.")

pop_genome_wcvp_all_area_vs_jac_figure = correct_and_plot(genome_mod_mat_wcvp_all_area, genome_wcvp_all_area_vs_jac$y, genome_wcvp_all_area_vs_jac$Vt, "log10(wcvp_all_area)", "log(WCVP full range, km^2), adj.", "Jaccard dissimilarity, adj.")

pop_genome_wcvp_all_area_vs_bcd_figure = correct_and_plot(genome_mod_mat_wcvp_all_area, genome_wcvp_all_area_vs_bcd$y, genome_wcvp_all_area_vs_bcd$Vt, "log10(wcvp_all_area)", "log(WCVP full range, km^2), adj.", "Bray-Curtis dissimilarity, adj.")

## wcvp native range size
pop_genome_wcvp_native_area_vs_pi_figure = correct_and_plot(genome_mod_mat_wcvp_native_area, genome_wcvp_native_area_vs_pi$y, genome_wcvp_native_area_vs_pi$Vt, "log10(wcvp_native_area)", "log(WCVP native range, km^2), adj.", "log(Nucleotide diversity), adj.")

pop_genome_wcvp_native_area_vs_jac_figure = correct_and_plot(genome_mod_mat_wcvp_native_area, genome_wcvp_native_area_vs_jac$y, genome_wcvp_native_area_vs_jac$Vt, "log10(wcvp_native_area)", "log(WCVP native range, km^2), adj.", "Jaccard dissimilarity, adj.")

pop_genome_wcvp_native_area_vs_bcd_figure = correct_and_plot(genome_mod_mat_wcvp_native_area, genome_wcvp_native_area_vs_bcd$y, genome_wcvp_native_area_vs_bcd$Vt, "log10(wcvp_native_area)", "log(WCVP native range, km^2), adj.", "Bray-Curtis dissimilarity, adj.")

## height
pop_genome_height_vs_pi_figure = correct_and_plot(genome_mod_mat_height, genome_height_vs_pi$y, genome_height_vs_pi$Vt, "log10(height_final)", "log(height in m), adj.", "log(Nucleotide diversity), adj.")

pop_genome_height_vs_jac_figure = correct_and_plot(genome_mod_mat_height, genome_height_vs_jac$y, genome_height_vs_jac$Vt, "log10(height_final)", "log(height in m), adj.", "Jaccard dissimilarity, adj.")

pop_genome_height_vs_bcd_figure = correct_and_plot(genome_mod_mat_height, genome_height_vs_bcd$y, genome_height_vs_bcd$Vt, "log10(height_final)", "log(height in m), adj.", "Bray-Curtis dissimilarity, adj.")
```

## DEPRECATED: Do k-mers uncover more between species variation?
```{r eval=FALSE, include=FALSE}

# calculate ratio of observed k-mer differences to expected number of k-mer differences based on SNP-differences alone
subdiv$obs_vs_exp_uncor = subdiv$umean/(30*subdiv$pi*subdiv$ntotal*choose(subdiv$nidv, 2))

subdiv$obs_vs_exp_low = (0.05/(subdiv$ntotal/subdiv$genome.size)) * subdiv$umean/(30*subdiv$pi*subdiv$ntotal*choose(subdiv$nidv, 2))
subdiv$obs_vs_exp_med = (0.01/(subdiv$ntotal/subdiv$genome.size)) * subdiv$umean/(30*subdiv$pi*subdiv$ntotal*choose(subdiv$nidv, 2))
subdiv$obs_vs_exp_high = (0.005/(subdiv$ntotal/subdiv$genome.size)) * subdiv$umean/(30*subdiv$pi*subdiv$ntotal*choose(subdiv$nidv, 2))

# A point mutation generates up to k new k-mers in a genome
# Thus, each SNP corresponds to at most k presence-absence differences in a pair of genomes
subdiv$excess_color = ifelse(subdiv$obs_vs_exp_uncor > 1, "TRUE", "FALSE")

ggplot(subdiv, aes(x = reorder(species,-obs_vs_exp_uncor), y = log10(obs_vs_exp_uncor), fill = excess_color)) +
  geom_bar(stat = "identity") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  geom_hline(yintercept = log10(1)) +
  scale_fill_manual(values = scico(2, palette = "berlin")) +
  scale_color_manual(values = scico(2, palette = "berlin")) +
  labs(x = "Species", y = "log(observed k-mer diff./expected k-mer diff.)", fill = "Obs. > Exp.") +
  coord_flip()





# calculate mean, variance accounting for phylogeny
pi_int = pgls(-log10(pi) ~ 1, data = compdata)
jac_int = pgls(jac ~ 1, data = compdata)
bcd_int = pgls(bcd ~ 1, data = compdata)

phylocv = function(mod){
  my_sd = sqrt(sum(mod$residuals**2)/(length(mod$residuals) - 1))
  my_mean = coefficients(mod)
  return(my_sd/my_mean)
}

phylocv(pi_int)
phylocv(jac_int)
phylocv(bcd_int)

# coefficients of variation for raw data
IQR(log10(subdiv$pi))/median(log10(subdiv$pi))

IQR(subdiv$jac)/median(subdiv$jac)

IQR(subdiv$bcd)/median(subdiv$bcd)

# de-correlate observations due to relatedness
# Get cholesky decomposition of variance covariance matrix
# then invert the matrix
# then transpose it
C_inv = t(solve(chol(compdata$vcv)))
  
# scale data by phylogenetic effect
# This translates the generalized least squares model into an ordinary least squares model
pi_star = C_inv %*% log10(subdiv$pi)
jac_star = C_inv %*% (subdiv$jac)
bcd_star = C_inv %*% (subdiv$bcd)

# coefficients of variation for de-correlated data
(sd(jac_star)/mean(jac_star))/(sd(pi_star)/mean(pi_star))

(sd(bcd_star)/mean(bcd_star))/(sd(pi_star)/mean(pi_star))

# bootstrap test for whether coefficient of variation is higher for k-mers than SNP diversity 
my_bootstrap_test = function(x,y,n,b){
  result = c()
  for(i in 1:b){
    # resample
    sams = sample(1:length(x), size = n, replace = T)
    x_sam = x[sams]
    y_sam = y[sams]
    #calculate test statistic
    #test_stat = sd(y_sam)/mean(y_sam) - sd(x_sam)/mean(y_sam)
    yq1 = quantile(y_sam, probs = 0.25)
    yq3 = quantile(y_sam, probs = 0.75)
    
    xq1 = quantile(x_sam, probs = 0.25)
    xq3 = quantile(x_sam, probs = 0.75)
    
    test_stat = abs(((yq3 - yq1)/2)/((yq3 + yq1)/2)) - abs(((xq3 - xq1)/2)/((xq3 + xq1)/2))
    
        # save result
    result = c(result, test_stat)
  }
  return(result)
}

# BOOTstrap test
pi_vs_jac_cv = my_bootstrap_test(pi_star, jac_star, length(pi_star), 10000)
hist(pi_vs_jac_cv)
quantile(pi_vs_jac_cv, probs = 0.95)
```

# Final plots

```{r}
# make initial data analysis plots, confirming relationship between WCVP and GBIF, jaccard and bray-curtis
ggarrange(ida_wcvp_vs_gbif_all, ida_wcvp_vs_gbif_native, ida_wcvp_all_vs_wcvp_native, ida_gbif_all_vs_gbif_native, nrow = 2, ncol = 2, labels = c("A", "B", "C", "D"), font.label = list(size = 12), hjust = -2)

#ggsave(paste("wcvp_vs_gbif_", today, ".tiff", sep = ""), width = 6, height = 6, scale = 1, compression = "lzw")
ggsave(paste("wcvp_vs_gbif_", today, ".pdf", sep = ""), width = 6, height = 6, device = cairo_pdf)

# Jaccard vs bray-curtis dissimilarity
ggsave(paste("ida_jac_vs_bcd_", today, ".pdf", sep = ""), ida_jac_vs_bcd, width = 4, height = 4, device = cairo_pdf)

# Look at sequencing metrics influence diversity
ggarrange(ida_meancov_vs_pi, ida_cvbp_vs_pi, ida_nidv_vs_pi, ida_meancov_vs_jac, ida_cvbp_vs_jac, ida_nidv_vs_jac, ida_meancov_vs_bcd, ida_cvbp_vs_bcd, ida_nidv_vs_bcd, ncol = 3, nrow = 3, labels = c("A", "B", "C", "D", "E", "F", "G", "H", "I"), font.label = list(size = 12))

ggsave(paste("coverage_vs_diversity_", today, ".pdf", sep = ""), width = 10, height = 8, units = "in", device = cairo_pdf)

# Look at how mating system, cultivation status, ploidy influence diversity
#ggarrange(ida_mating_vs_pi, ida_cult_vs_pi, ida_ploidy_vs_pi, ida_mating_vs_jac, ida_cult_vs_jac, ida_ploidy_vs_jac, ida_mating_vs_bcd, ida_cult_vs_bcd, ida_ploidy_vs_bcd, ncol = 3, nrow = 3, labels = c("A", "B", "C", "D", "E", "F", "G", "H"))

#ggsave(paste("mating_cultivation_ploidy_vs_diversity_", today, ".pdf", sep = ""), width = 10, height = 10, units = "in")

# Compare how k-mer metrics compare to SNP metrics after removing low coverage data
ggarrange(ida_pi_vs_bcd, cda_pi_vs_bcd, ncol = 2, nrow = 1, common.legend = T, labels = c("A", "B"), legend = "top", font.label = list(size = 12))

ggsave(paste("pi_vs_bcd_high_vs_low_cov_", today, ".tiff", sep = ""), width = 6, height = 4, units = "in", compression = "lzw")
ggsave(paste("pi_vs_bcd_high_vs_low_cov_", today, ".pdf", sep = ""), width = 6, height = 4, units = "in", device = cairo_pdf)

ggarrange(ida_pi_vs_jac, cda_pi_vs_jac, ncol = 2, nrow = 1, common.legend = T, labels = c("A", "B"), legend = "top", font.label = list(size = 12))

ggsave(paste("pi_vs_jac_high_vs_low_cov_", today, ".pdf", sep = ""), width = 6, height = 4, units = "in", device = cairo_pdf)

# Look at how cv in sequencing affect SNP vs k-mer comparison
ggarrange(ida_pi_vs_jac_cvbp, ida_pi_vs_bcd_cvbp, ncol = 2, nrow = 1, common.legend = T, labels = c("A", "B"), legend = "top", font.label = list(size = 12))

ggsave(paste("pi_vs_jac_and_bcd_cvbp_", today, ".pdf", sep = ""), width = 9, height = 6, units = "in", device = cairo_pdf)

# Look at how number of individuals sequenced affects SNP vs k-mer comparison
ggarrange(ida_pi_vs_jac_nidv, ida_pi_vs_bcd_nidv, ncol = 2, nrow = 1, common.legend = T, labels = c("A", "B"), legend = "top", font.label = list(size = 12))

ggsave(paste("pi_vs_jac_and_bcd_nidv_", today, ".pdf", sep = ""), width = 9, height = 6, units = "in", device = cairo_pdf)

# Simple barplot of how cultivation varies with generation and mating system
ggarrange(ida_cultivation_vs_generation, ida_cultivation_vs_mating, ida_generation_vs_mating, labels = c("A", "B", "C"), font.label = list(size = 12), ncol = 3, nrow = 1, legend = "right")

ggsave(paste("cultivation_vs_generation_and_mating", today, ".pdf", sep = ""), width = 15, height = 4, units = "in", device = cairo_pdf)

# Compare population sizes to diversity metrics, without correcting for phylogeny
ggarrange(cda_pi_vs_gbif, cda_pi_vs_wcvp, cda_jac_vs_gbif, cda_jac_vs_wcvp, cda_bcd_vs_gbif, cda_bcd_vs_wcvp, nrow = 3, ncol = 2, labels = c("A", "B", "C", "D", "E", "F"), font.label = list(size = 12))

ggsave(paste("diversity_vs_popsize_", today, ".pdf", sep = ""), width = 6, height = 8, units = "in", device = cairo_pdf)

#### plot phylogenetic least squares models ####

## population size vs diversity, excluding genome size

### Figure 3
ggarrange(wcvp_native_vs_pi_corrected, wcvp_native_vs_jac_corrected, wcvp_native_vs_bcd_corrected,wcvp_all_vs_pi_corrected, wcvp_all_vs_jac_corrected, wcvp_all_vs_bcd_corrected, nrow = 2, ncol = 3, labels = c("A", "B", "C", "D", "E", "F"), font.label = list(size = 12))

ggsave(paste("wcvp_popsize_vs_diversity_corrected_", today, ".pdf", sep = ""), height = 6, width = 7.5, units = "in")

### supplemental figures
ggarrange(wcvp_native_area_vs_pi_corrected, wcvp_native_area_vs_jac_corrected, wcvp_native_area_vs_bcd_corrected,wcvp_all_area_vs_pi_corrected, wcvp_all_area_vs_jac_corrected, wcvp_all_area_vs_bcd_corrected, nrow = 2, ncol = 3, labels = c("A", "B", "C", "D", "E", "F"), font.label = list(size = 12))

ggsave(paste("wcvp_area_vs_diversity_corrected_", today, ".pdf", sep = ""), height = 6, width = 7.5, units = "in")

ggarrange(gbif_native_vs_pi_corrected, gbif_native_vs_jac_corrected, gbif_native_vs_bcd_corrected,gbif_all_vs_pi_corrected, gbif_all_vs_jac_corrected, gbif_all_vs_bcd_corrected, nrow = 2, ncol = 3, labels = c("A", "B", "C", "D", "E", "F"), font.label = list(size = 12))

ggsave(paste("gbif_popsize_vs_diversity_corrected_", today, ".pdf", sep = ""), height = 6, width = 7.5, units = "in")

ggarrange(gbif_native_area_vs_pi_corrected, gbif_native_area_vs_jac_corrected, gbif_native_area_vs_bcd_corrected,gbif_all_area_vs_pi_corrected, gbif_all_area_vs_jac_corrected, gbif_all_area_vs_bcd_corrected, nrow = 2, ncol = 3, labels = c("A", "B", "C", "D", "E", "F"), font.label = list(size = 12))

ggsave(paste("gbif_area_vs_diversity_corrected_", today, ".pdf", sep = ""), height = 6, width = 7.5, units = "in")

ggarrange(height_vs_pi_corrected, height_vs_jac_corrected, height_vs_bcd_corrected, nrow = 1, ncol = 3, labels = c("A", "B", "C"), font.label = list(size = 12))

ggsave(paste("height_vs_diversity_corrected_", today, ".pdf", sep = ""), height = 3, width = 7.5, units = "in")

## population size vs diversity, including genome size

### Figure 3
ggarrange(pop_genome_wcvp_all_vs_pi_figure, pop_genome_wcvp_all_vs_bcd_figure, nrow = 1, ncol = 2, labels = c("A", "B"), font.label = list(size = 12))

ggsave(paste("wcvp_all_popsize_vs_pi_and_bcd_genome-size-corrected_", today, ".tiff", sep = ""), height = 3, width = 5, units = "in", compression = "lzw")
ggsave(paste("wcvp_all_popsize_vs_pi_and_bcd_genome-size-corrected_", today, ".pdf", sep = ""), height = 3, width = 5, units = "in")

ggarrange(pop_genome_wcvp_all_vs_jac_figure)

ggsave(paste("wcvp_all_popsize_vs_jac_genome-size-corrected_", today, ".pdf", sep = ""), height = 3, width = 3, units = "in")

ggarrange(pop_genome_wcvp_native_vs_pi_figure, pop_genome_wcvp_native_vs_jac_figure, pop_genome_wcvp_native_vs_bcd_figure, nrow = 1, ncol = 3, labels = c("A", "B", "C"), font.label = list(size = 12))

ggsave(paste("wcvp_native_popsize_vs_diversity_genome-size-corrected_", today, ".pdf", sep = ""), height = 3, width = 7.5, units = "in")

### supplemental figures
ggarrange(pop_genome_gbif_native_vs_pi_figure, pop_genome_gbif_native_vs_jac_figure, pop_genome_gbif_native_vs_bcd_figure,pop_genome_gbif_all_vs_pi_figure, pop_genome_gbif_all_vs_jac_figure, pop_genome_gbif_all_vs_bcd_figure, nrow = 2, ncol = 3, labels = c("A", "B", "C", "D", "E", "F"), font.label = list(size = 12))

ggsave(paste("gbif_popsize_vs_diversity_genome-size-corrected_", today, ".pdf", sep = ""), height = 6, width = 7.5, units = "in")

ggarrange(pop_genome_wcvp_native_area_vs_pi_figure, pop_genome_wcvp_native_area_vs_jac_figure, pop_genome_wcvp_native_area_vs_bcd_figure,pop_genome_wcvp_all_area_vs_pi_figure, pop_genome_wcvp_all_area_vs_jac_figure, pop_genome_wcvp_all_area_vs_bcd_figure, nrow = 2, ncol = 3, labels = c("A", "B", "C", "D", "E", "F"), font.label = list(size = 12))

ggsave(paste("wcvp_area_vs_diversity_genome-size-corrected_", today, ".pdf", sep = ""), height = 6, width = 7.5, units = "in")

ggarrange(pop_genome_gbif_native_area_vs_pi_figure, pop_genome_gbif_native_area_vs_jac_figure, pop_genome_gbif_native_area_vs_bcd_figure,pop_genome_gbif_all_area_vs_pi_figure, pop_genome_gbif_all_area_vs_jac_figure, pop_genome_gbif_all_area_vs_bcd_figure, nrow = 2, ncol = 3, labels = c("A", "B", "C", "D", "E", "F"), font.label = list(size = 12))

ggsave(paste("gbif_area_vs_diversity_genome-size-corrected_", today, ".pdf", sep = ""), height = 6, width = 7.5, units = "in")

ggarrange(pop_genome_height_vs_pi_figure, pop_genome_height_vs_jac_figure, pop_genome_height_vs_bcd_figure, nrow = 1, ncol = 3, labels = c("A", "B", "C"), font.label = list(size = 12))

ggsave(paste("height_vs_diversity_genome-size-corrected_", today, ".pdf", sep = ""), height = 4, width = 7.5, units = "in")

## genome size vs diversity

### Figure 4
ggarrange(genome_wcvp_all_vs_pi_figure, genome_wcvp_all_vs_bcd_figure, nrow = 1, ncol = 2, labels = c("A", "B"), font.label = list(size = 12))

ggsave(paste("pi_bcd_vs_genome_size_wcvp-all-corrected_", today, ".tiff", sep = ""), height = 3, width = 5, units = "in", compression = "lzw")
ggsave(paste("pi_bcd_vs_genome_size_wcvp-all-corrected_", today, ".pdf", sep = ""), height = 3, width = 5, units = "in")

ggarrange(genome_wcvp_all_vs_jac_figure)

ggsave(paste("jac_vs_genome_size_wcvp-all-corrected_", today, ".pdf", sep = ""), height = 3, width = 3, units = "in")

ggarrange(genome_wcvp_native_vs_pi_figure, genome_wcvp_native_vs_jac_figure, genome_wcvp_native_vs_bcd_figure, nrow = 1, ncol = 3, labels = c("A", "B", "C"), font.label = list(size = 12))

ggsave(paste("pi_jac_bcd_vs_genome_size_wcvp-native-corrected_", today, ".pdf", sep = ""), height = 3, width = 7.5, units = "in")

### supplemental figures

ggarrange(genome_gbif_native_vs_pi_figure, genome_gbif_native_vs_jac_figure, genome_gbif_native_vs_bcd_figure,genome_gbif_all_vs_pi_figure, genome_gbif_all_vs_jac_figure, genome_gbif_all_vs_bcd_figure, nrow = 2, ncol = 3, labels = c("A", "B", "C", "D", "E", "F"), font.label = list(size = 12))

ggsave(paste("gbif_popsize_vs_genome_size_corrected_", today, ".pdf", sep = ""), height = 6, width = 7.5, units = "in")

ggarrange(genome_wcvp_native_area_vs_pi_figure, genome_wcvp_native_area_vs_jac_figure, genome_wcvp_native_area_vs_bcd_figure,genome_wcvp_all_area_vs_pi_figure, genome_wcvp_all_area_vs_jac_figure, genome_wcvp_all_area_vs_bcd_figure, nrow = 2, ncol = 3, labels = c("A", "B", "C", "D", "E", "F"), font.label = list(size = 12))

ggsave(paste("wcvp_area_vs_genome_size_corrected_", today, ".pdf", sep = ""), height = 6, width = 7.5, units = "in")

ggarrange(genome_gbif_native_area_vs_pi_figure, genome_gbif_native_area_vs_jac_figure, genome_gbif_native_area_vs_bcd_figure,genome_gbif_all_area_vs_pi_figure, genome_gbif_all_area_vs_jac_figure, genome_gbif_all_area_vs_bcd_figure, nrow = 2, ncol = 3, labels = c("A", "B", "C", "D", "E", "F"), font.label = list(size = 12))

ggsave(paste("gbif_area_vs_genome_size_corrected_", today, ".pdf", sep = ""), height = 6, width = 7.5, units = "in")

ggarrange(genome_height_vs_pi_figure, genome_height_vs_jac_figure, genome_height_vs_bcd_figure, nrow = 1, ncol = 3, labels = c("A", "B", "C"), font.label = list(size = 12))

ggsave(paste("height_vs_genome_size_corrected_", today, ".pdf", sep = ""), height = 4, width = 7.5, units = "in")

#### save results of phylogenetic least squares models as tables ###

all_mod_results = rbind(
  summary(mod_gbif_all_popsize_pi)$coefficients,
  summary(mod_gbif_all_popsize_jac)$coefficients,
  summary(mod_gbif_all_popsize_bcd)$coefficients,
  summary(mod_gbif_all_area_pi)$coefficients,
  summary(mod_gbif_all_area_jac)$coefficients,
  summary(mod_gbif_all_area_bcd)$coefficients,
  summary(mod_gbif_native_popsize_pi)$coefficients,
  summary(mod_gbif_native_popsize_jac)$coefficients,
  summary(mod_gbif_native_popsize_bcd)$coefficients,
  summary(mod_gbif_native_area_pi)$coefficients,
  summary(mod_gbif_native_area_jac)$coefficients,
  summary(mod_gbif_native_area_bcd)$coefficients,
  summary(mod_wcvp_all_popsize_pi)$coefficients,
  summary(mod_wcvp_all_popsize_jac)$coefficients,
  summary(mod_wcvp_all_popsize_bcd)$coefficients,
  summary(mod_wcvp_all_area_pi)$coefficients,
  summary(mod_wcvp_all_area_jac)$coefficients,
  summary(mod_wcvp_all_area_bcd)$coefficients,
  summary(mod_wcvp_native_popsize_pi)$coefficients,
  summary(mod_wcvp_native_popsize_jac)$coefficients,
  summary(mod_wcvp_native_popsize_bcd)$coefficients,
  summary(mod_wcvp_native_area_pi)$coefficients,
  summary(mod_wcvp_native_area_jac)$coefficients,
  summary(mod_wcvp_native_area_bcd)$coefficients,
  summary(mod_height_pi)$coefficients,
  summary(mod_height_jac)$coefficients,
  summary(mod_height_bcd)$coefficients,
  summary(genome_wcvp_all_vs_pi)$coefficients,
  summary(genome_wcvp_all_vs_jac)$coefficients,
  summary(genome_wcvp_all_vs_bcd)$coefficients,
  summary(genome_wcvp_native_vs_pi)$coefficients,
  summary(genome_wcvp_native_vs_jac)$coefficients,
  summary(genome_wcvp_native_vs_bcd)$coefficients,
  summary(genome_wcvp_all_area_vs_pi)$coefficients,
  summary(genome_wcvp_all_area_vs_jac)$coefficients,
  summary(genome_wcvp_all_area_vs_bcd)$coefficients,
  summary(genome_wcvp_native_area_vs_pi)$coefficients,
  summary(genome_wcvp_native_area_vs_jac)$coefficients,
  summary(genome_wcvp_native_area_vs_bcd)$coefficients,
  summary(genome_gbif_all_vs_pi)$coefficients,
  summary(genome_gbif_all_vs_jac)$coefficients,
  summary(genome_gbif_all_vs_bcd)$coefficients,
  summary(genome_gbif_native_vs_pi)$coefficients,
  summary(genome_gbif_native_vs_jac)$coefficients,
  summary(genome_gbif_native_vs_bcd)$coefficients,
  summary(genome_gbif_all_area_vs_pi)$coefficients,
  summary(genome_gbif_all_area_vs_jac)$coefficients,
  summary(genome_gbif_all_area_vs_bcd)$coefficients,
  summary(genome_gbif_native_area_vs_pi)$coefficients,
  summary(genome_gbif_native_area_vs_jac)$coefficients,
  summary(genome_gbif_native_area_vs_bcd)$coefficients,
  summary(genome_height_vs_pi)$coefficients,
  summary(genome_height_vs_jac)$coefficients,
  summary(genome_height_vs_bcd)$coefficients
)

# create column from row names
all_mod_results = cbind(all_mod_results, rownames(all_mod_results))

# convert to dataframe
all_mod_results = as.data.frame(all_mod_results)

# add some extra descriptors: name of response variable and model id, so that readers know which values are all together in one model
all_mod_results$Response = c(
  rep(mod_gbif_all_popsize_pi$namey, times = 5),
  rep(mod_gbif_all_popsize_jac$namey, times = 5),
  rep(mod_gbif_all_popsize_bcd$namey, times = 5),
  rep(mod_gbif_all_area_pi$namey, times = 5),
  rep(mod_gbif_all_area_jac$namey, times = 5),
  rep(mod_gbif_all_area_bcd$namey, times = 5),
  rep(mod_gbif_native_popsize_pi$namey, times = 5),
  rep(mod_gbif_native_popsize_jac$namey, times = 5),
  rep(mod_gbif_native_popsize_bcd$namey, times = 5),
  rep(mod_gbif_native_area_pi$namey, times = 5),
  rep(mod_gbif_native_area_jac$namey, times = 5),
  rep(mod_gbif_native_area_bcd$namey, times = 5),
  rep(mod_wcvp_all_popsize_pi$namey, times = 5),
  rep(mod_wcvp_all_popsize_jac$namey, times = 5),
  rep(mod_wcvp_all_popsize_bcd$namey, times = 5),
  rep(mod_wcvp_all_area_pi$namey, times = 5),
  rep(mod_wcvp_all_area_jac$namey, times = 5),
  rep(mod_wcvp_all_area_bcd$namey, times = 5),
  rep(mod_wcvp_native_popsize_pi$namey, times = 5),
  rep(mod_wcvp_native_popsize_jac$namey, times = 5),
  rep(mod_wcvp_native_popsize_bcd$namey, times = 5),
  rep(mod_wcvp_native_area_pi$namey, times = 5),
  rep(mod_wcvp_native_area_jac$namey, times = 5),
  rep(mod_wcvp_native_area_bcd$namey, times = 5),
  rep(mod_height_pi$namey, times = 5),
  rep(mod_height_jac$namey, times = 5),
  rep(mod_height_bcd$namey, times = 5),
  rep(genome_wcvp_all_vs_pi$namey, times = 6),
  rep(genome_wcvp_all_vs_jac$namey, times = 6),
  rep(genome_wcvp_all_vs_bcd$namey, times = 6),
  rep(genome_wcvp_native_vs_pi$namey, times = 6),
  rep(genome_wcvp_native_vs_jac$namey, times = 6),
  rep(genome_wcvp_native_vs_bcd$namey, times = 6),
  rep(genome_wcvp_all_area_vs_pi$namey, times = 6),
  rep(genome_wcvp_all_area_vs_jac$namey, times = 6),
  rep(genome_wcvp_all_area_vs_bcd$namey, times = 6),
  rep(genome_wcvp_native_area_vs_pi$namey, times = 6),
  rep(genome_wcvp_native_area_vs_jac$namey, times = 6),
  rep(genome_wcvp_native_area_vs_bcd$namey, times = 6),
  rep(genome_gbif_all_vs_pi$namey, times = 6),
  rep(genome_gbif_all_vs_jac$namey, times = 6),
  rep(genome_gbif_all_vs_bcd$namey, times = 6),
  rep(genome_gbif_native_vs_pi$namey, times = 6),
  rep(genome_gbif_native_vs_jac$namey, times = 6),
  rep(genome_gbif_native_vs_bcd$namey, times = 6),
  rep(genome_gbif_all_area_vs_pi$namey, times = 6),
  rep(genome_gbif_all_area_vs_jac$namey, times = 6),
  rep(genome_gbif_all_area_vs_bcd$namey, times = 6),
  rep(genome_gbif_native_area_vs_pi$namey, times = 6),
  rep(genome_gbif_native_area_vs_jac$namey, times = 6),
  rep(genome_gbif_native_area_vs_bcd$namey, times = 6),
  rep(genome_height_vs_pi$namey, times = 6),
  rep(genome_height_vs_jac$namey, times = 6),
  rep(genome_height_vs_bcd$namey, times = 6)
)

all_mod_results$ID = c(
  rep(1, times = 5),
  rep(2, times = 5),
  rep(3, times = 5),
  rep(4, times = 5),
  rep(5, times = 5),
  rep(6, times = 5),
  rep(7, times = 5),
  rep(8, times = 5),
  rep(9, times = 5),
  rep(10, times = 5),
  rep(11, times = 5),
  rep(12, times = 5),
  rep(13, times = 5),
  rep(14, times = 5),
  rep(15, times = 5),
  rep(16, times = 5),
  rep(17, times = 5),
  rep(18, times = 5),
  rep(19, times = 5),
  rep(20, times = 5),
  rep(21, times = 5),
  rep(22, times = 5),
  rep(23, times = 5),
  rep(24, times = 5),
  rep(25, times = 5),
  rep(26, times = 5),
  rep(27, times = 5),
  rep(28, times = 6),
  rep(29, times = 6),
  rep(30, times = 6),
  rep(31, times = 6),
  rep(32, times = 6),
  rep(33, times = 6),
  rep(34, times = 6),
  rep(35, times = 6),
  rep(36, times = 6),
  rep(37, times = 6),
  rep(38, times = 6),
  rep(39, times = 6),
  rep(40, times = 6),
  rep(41, times = 6),
  rep(42, times = 6),
  rep(43, times = 6),
  rep(44, times = 6),
  rep(45, times = 6),
  rep(46, times = 6),
  rep(47, times = 6),
  rep(48, times = 6),
  rep(49, times = 6),
  rep(50, times = 6),
  rep(51, times = 6),
  rep(52, times = 6),
  rep(53, times = 6),
  rep(54, times = 6)
)

#all_mod_results$Response = rep(
#    c(
#      rep("Nucleotide diversity", times = 5),
#      rep("Jaccard dissimilarity", times = 5),
#      rep("Bray-Curtis dissimilarity", times = 5)
#    ),
#    times = 9
#)

#all_mod_results$`Population size metric` = c(
#  rep("GBIF", times = 30),
#  rep("WCVP", times = 30)
#)

#all_mod_results$`Range included` = c(
#  rep("full", times = 15),
#  rep("native only", times = 15),
#  rep("full", times = 15),
#  rep("native only", times = 15)
#)

# reorganize the columns
all_mod_results = all_mod_results[,c(7,6,5,1:4)]

colnames(all_mod_results)[3] = "Variable"

# save results
write.csv(all_mod_results, paste("model_coefficients_", today, ".csv", sep = ""), row.names = F)
```

# DEPRECATED
```{r}
# pi vs bcd
ggplot(alldiv, aes(x = bcd, y = log10(pi), label = species)) +
  geom_point() +
  geom_text(position = position_jitter(seed = 1)) +
  theme_classic() +
  xlim(0,0.8) +
  labs(x = "Bray-Curtis dissimilarity", y = "log10(Nucleotide diversity)")
ggsave(paste("../results/2023-03-26/figures/Bray-CurtisDissimilarityVsPi_", today, ".png", sep = ""), width = 7, height = 7, unit = "in", scale = 0.5)

# range vs pi
r1 = ggplot(alldiv, aes(x = log10(rangeArea), y = log10(pi), label = species)) +
  geom_point() +
  geom_text(position = position_jitter(seed = 1)) +
  geom_smooth(method = "auto") +
  theme_classic() +
  theme(text = element_text(size = 12)) +
  xlim(5.5, 8.5) +
  labs(x = "log10(Range area in square km)", y = "log10(Nucleotide diversity)")

#ggsave(paste("../results/2023-03-26/figures/rangeVsPi_", today, ".png", sep = ""), width = 7, height = 7, unit = "in", scale = 0.5)

# range vs bcd
r2 = ggplot(alldiv, aes(x = log10(rangeArea), y = bcd, label = species)) +
  geom_point() +
  geom_text(position = position_jitter(seed = 1)) + 
  geom_smooth(method = "auto") +
  theme_classic() +
  theme(text = element_text(size = 12)) +
  xlim(5.5, 8.5) +
  labs(x = "log10(Range area in square km)", y = "Bray-Curtis dissimilarity")

#ggsave(paste("../results/2023-03-26/figures/rangeVsBray-Curtis_", today, ".png", sep = ""), width = 7, height = 7, unit = "in", scale = 0.5)

# range vs jaccard dissimilarity
r3 = ggplot(alldiv, aes(x = log10(rangeArea), y = jac, label = species)) +
  geom_point() +
  geom_text(position = position_jitter(seed = 1)) + 
  geom_smooth(method = "auto") +
  theme_classic() +
  theme(text = element_text(size = 12)) +
  xlim(5.5, 8.5) +
  labs(x = "log10(Range area in square km)", y = "Jaccard dissimilarity")

gridplot = plot_grid(r1, r2, r3, labels = "AUTO", ncol = 3)

ggsave(paste("../results/2023-03-26/figures/range_vs_diversity_", today, ".png", sep = ""), width = 21, height = 7)
       
#ggsave(paste("../results/2023-03-26/figures/rangeVsJaccard_", today, ".png", sep = ""), width = 7, height = 7, unit = "in", scale = 0.5)
```

# plot phylogeny alongside data

ggtree causes linear models to crash, so need to do this separately

```{r}
#install.packages("ggtree")
#if (!require("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
#BiocManager::install("ggtree")

#install.packages("ggtree")
library(ggtree)

# test ggtree package
#tr = rtree(10)
#ggtree(tr) + geom_tiplab()

# arrange plot data to match order of tip labels
plotdf = alldiv %>% arrange(factor(species, levels = phy$tip.label))

plotdf$Ploidy = as.numeric(plotdf$Ploidy)

plotdf = plotdf[!is.na(plotdf$species),]

# remove species from phylogeny that lack data
plotphy = drop.tip(phy, tip = phy$tip.label[!(phy$tip.label %in% alldiv$species)])

# change tip labels to be mating system
#plotphy$tip.label = plotdf$Mating.system

 # get color pallete
#plotpal = scico(5, palette = "lipari")
plotpal = c("#021326", "#3B5378", "#7F5F70", "#CE685E", "#E5AA7F")
#plotpal = c("#021326","#294B70","#6B5F76","#A36267","#E57A61","#E5B488","#FDF4D9")
#plotpal = c("#021326","#3B5378","#7F5F70","#CE685E","#E5AA7F","#FDF4D9")
#plotpal = c("#191900","#663329","#D85F4D","#ECAC54","#FFFECB")

# plot phylogeny alongside other data
ggtree(plotphy, size = 1.5) + 
  geom_tiplab(size = 2) +
  #geom_facet(panel = "log10(GBIF native ratio)", data = plotdf, geom = geom_segment, size = 3, mapping = aes(x = 0, y = y, yend = y, xend = log10(gbif_native_popsize)), color = plotpal[1]) +
  geom_facet(panel = "log(WCVP full ratio)", data = plotdf, geom = geom_segment, size = 3, mapping = aes(x = 0, y = y, yend = y, xend = log10(wcvp_all_popsize)), color = plotpal[2]) +
  geom_facet(panel = "log(Nucleotide diversity)", data = plotdf, geom = geom_segment, size = 3, mapping = aes(x = 0, y = y, yend = y, xend = log10(pi)), color = plotpal[3]) +
  geom_facet(panel = "Bray-Curtis dissimilarity", data = plotdf, geom = geom_segment, size = 3, mapping = aes(x = 0, y = y, yend = y, xend = bcd), color = plotpal[4]) +
  #geom_facet(panel = "Jaccard dissimilarity", data = plotdf, geom = geom_segment, size = 3, mapping = aes(x = 0, y = y, yend = y, xend = jac), color = plotpal[5]) +
  theme_tree2() +
  theme(strip.background = element_rect(fill="white")) +
  theme(strip.text = element_text(colour = 'black'), text = element_text(size = 12)) +
  xlim_tree(400)
  
ggsave(paste("tree_with_primary_variables_", today, ".tiff", sep = ""), width = 7.5, height = 7.75, compression = "lzw")
ggsave(paste("tree_with_primary_variables_", today, ".pdf", sep = ""), width = 7.5, height = 7.75)

# plot technical variables
ggtree(plotphy, size = 1.5) +
  geom_tiplab(size = 2) +
  #geom_tippoint(mapping = aes(shape = Mating.system), data = plotdf, size = 1.5) + 
  #geom_facet(panel = "Ploidy", data = plotdf, geom = geom_segment, size = 3, mapping = aes(x = 0, y = y, yend = y, xend = Ploidy), color = plotpal[1]) +
  #geom_facet(panel = "Genome size", data = plotdf, geom = geom_segment, size = 3, mapping = aes(x = 0, y = y, yend = y, xend = genome.size), color = plotpal[2]) +
  geom_facet(panel = "Individuals", data = plotdf, geom = geom_segment, size = 3, mapping = aes(x = 0, y = y, yend = y, xend = nidv), color = plotpal[3]) +
  geom_facet(panel = "Mean coverage", data = plotdf, geom = geom_segment, size = 3, mapping = aes(x = 0, y = y, yend = y, xend = (totalbp/(genome.size*nidv))), color = plotpal[4]) +
  geom_facet(panel = "CV in bp sequenced", data = plotdf, geom = geom_segment, size = 3, mapping = aes(x = 0, y = y, yend = y, xend = cvbp), color = plotpal[5]) +
  theme_tree2() +
  theme(strip.background = element_rect(fill="white")) +
  theme(strip.text = element_text(colour = 'black'), text = element_text(size = 12)) +
  xlim_tree(400)

ggsave(paste("tree_with_technical_variables_", today, ".pdf", sep = ""), width = 7.5, height = 7.75)

```

# DEPRECATED
```{r}
# subtract off effects of covariates from response
mod_mat_pi = model.matrix(~ log10(WCVP.popsize) + nidv + log10(genome.size) + cvbp + Mating.system, data = compdata$data)

mod_mat_jac = model.matrix(~ log10(WCVP.popsize) + log10(meancov) + nidv + log10(genome.size) + cvbp + Mating.system + cultivation.status, data = compdata$data)

mod_mat_bcd = model.matrix(~ log10(WCVP.popsize) + log10(meancov) + nidv + log10(genome.size) + cvbp + Mating.system + cultivation.status, data = compdata$data)

mod_coeff_pi = coefficients(mod_pi_3)

mod_coeff_jac = coefficients(mod_jac_1)

mod_coeff_bcd = coefficients(mod_bcd_1)

# Plotting response against summed linear model should give a 1:1 line
plot(mod_bcd_1$y, mod_mat %*% mod_coeff + mod_bcd_1$residuals)
abline(a = 0, b = 1)

# correct response for phylogeny and other covariates, then plot against predictor of interest
C_inv_pi = t(solve(chol(mod_pi_3$Vt)))
C_inv_jac = t(solve(chol(mod_jac_1$Vt)))
C_inv_bcd = t(solve(chol(mod_bcd_1$Vt)))

y_star_pi = C_inv_pi %*% mod_pi_3$y
X_star_pi = (C_inv_pi %*% mod_mat_pi)

y_star_jac = C_inv_jac %*% mod_jac_1$y
X_star_jac = (C_inv_jac %*% mod_mat_jac)

y_star_bcd = C_inv_bcd %*% mod_bcd_1$y
X_star_bcd = (C_inv_bcd %*% mod_mat_bcd)

# confirm that results of pgls match results of ordinary least squares on transformed data
# remove intercept column, already included in 
mod_star_bcd = lm(y_star_bcd ~ X_star_bcd - 1)
coeff_star_bcd = coefficients(mod_star_bcd)
(coeff_star_bcd - mod_coeff_bcd)/mod_coeff_bcd * 100 # percent difference in coefficients

# Isolate effect of covariate I'm interested in
# subtract extra covariates and slope from both sides of the equation
# Remember: the intercept is not a simple constant here! It's been scaled by C_inv
y_star_corrected_pi = y_star_pi - (X_star_pi[,c(1,3:ncol(X_star_pi))] %*% mod_coeff_pi[c(1,3:length(mod_coeff_pi))])

y_star_corrected_jac = y_star_jac - (X_star_jac[,c(1,3:ncol(X_star_jac))] %*% mod_coeff_jac[c(1,3:length(mod_coeff_jac))])

y_star_corrected_bcd = y_star_bcd - (X_star_bcd[,c(1,3:ncol(X_star_bcd))] %*% mod_coeff_bcd[c(1,3:length(mod_coeff_bcd))])

#plot(X_star[,2], y_star_corrected_2)
#abline(a = 0, coeff_star[2])

# plot response, scaled by phylogeny and corrected for other covariates, against diversity
my_ggplot_wrap_lm = function(x,y,b,xlab,ylab){
  myplot = ggplot(mapping = aes(x = x, y = y)) +
    geom_point() +
    geom_abline(intercept = 0, slope = b) +
    theme_classic() +
    labs(x = xlab, y = ylab)
    
  return(myplot)
}

my_ggplot_wrap_lm(X_star_pi[,2], y_star_corrected_pi, mod_coeff_pi[2], "log10(WCVP.popsize)")

my_ggplot_wrap_lm(X_star_jac[,2], y_star_corrected_jac, mod_coeff_jac[2])

my_ggplot_wrap_lm(X_star_bcd[,2], y_star_corrected_bcd, mod_coeff_bcd[2])





y_star_corrected = y_star - (X_star[,3:ncol(X_star)] %*% coeff_star[3:length(coeff_star)])

plot(X_star[,1:2] %*% mod_coeff[1:2], y_star_corrected) # data should center around 1:1 reference line
abline(a = 0, b = 1)

plot(X_star[,2], y_star_corrected[,1])
abline(a = mod_coeff[1], b = mod_coeff[2])

ggplot(mapping = aes(x = X_star[,2], y = y_star_corrected[,1]))+
  geom_point() +
  geom_smooth(method = "lm") +
  theme_classic()

test_mod = lm(y_star_corrected ~ X_star[,1:2] - 1)
plot(test_mod)

plot(C_inv %*% mod_bcd_1$y - (C_inv %*% mod_mat[,3:ncol(mod_mat)] %*% mod_coeff[3:length(mod_coeff)]), C_inv %*% mod_mat[,1:2] %*% mod_coeff[1:2] + C_inv %*% mod_bcd_1$residuals)
abline(a = 0, b = 1)

# Now leave out residuals
plot(mod_bcd_1$y - (mod_mat[,3:ncol(mod_mat)] %*% mod_coeff[3:length(mod_coeff)] + mod_bcd_1$phyres), log10(compdata$data$WCVP.popsize))

plot(C_inv %*% mod_bcd_1$y - (C_inv %*% mod_mat[,3:ncol(mod_mat)] %*% mod_coeff[3:length(mod_coeff)]), C_inv %*% mod_mat[,1:2] %*% mod_coeff[1:2])
abline(a = 0, b = 1)

# plot correlation between diversity, corrected for phylogeny and other covariates, with population size
plot(C_inv %*% mod_bcd_1$y - (C_inv %*% mod_mat[,3:ncol(mod_mat)] %*% mod_coeff[3:length(mod_coeff)]), C_inv %*% log10(compdata$data$WCVP.popsize))

y_corrected = C_inv %*% mod_bcd_1$y - (C_inv %*% mod_mat[,3:ncol(mod_mat)] %*% mod_coeff[3:length(mod_coeff)])

lm(y_corrected ~ C_inv %*% log10(compdata$data$WCVP.popsize))










y_corrected = compdata$data$bcd - (mod_mat[,3:ncol(mod_mat)] %*% mod_coeff[3:length(mod_coeff)])

cor.test(log10(compdata$data$WCVP.popsize), y_corrected , method = "spearman")

plot(log10(compdata$data$WCVP.popsize), y_corrected + mod_bcd_1$phyres)

# model diagnostics
plot(mod_pi)
plot(mod_pi$fitted, mod_pi$fitted - mod_pi$residuals)
abline(a = 0, b = 1)

plot(mod_jac)

plot(mod_bcd)






# plot out coefficients
coefplot = data.frame(coef = coefficients(mod_bcd), err = mod_bcd$sterr, label = names(mod_bcd$sterr))
coefplot = coefplot[-1,]
coefplot$coef = abs(coefplot$coef)

ggplot(coefplot, aes(x=coef, y=label)) + 
  geom_point()+
  geom_errorbar(aes(xmin=coef-err, xmax=coef+err), width=.2, position=position_dodge(0.05)) +
  geom_vline(xintercept = 0, lty = "dotted", size = 2) +
  theme_classic() +
  theme(text = element_text(size = 12)) +
  labs(x = "Absolute value of coefficient", y = "PGLS model parameter")

ggsave(paste("pgls_coefficients_", today, ".png", sep = ""), width = 7, height = 7)

mod_jac = pgls(log10(rangeArea) ~ scale(pi) + scale(jac), compdata)
summary(mod_jac)

# control for the number of individuals sequenced
mod_bcd = pgls(log10(rangeArea) ~ scale(pi) + scale(bcd), compdata)
summary(mod_bcd)

mod_jac = pgls(log10(rangeArea) ~ scale(pi) + scale(jac) + scale(nidv), compdata)
summary(mod_jac)

# control for amount of sequencing data
mod_bcd = pgls(log10(rangeArea) ~ scale(bcd), compdata)
summary(mod_bcd)
plot(mod_bcd)

mod_pi = pgls(log10(rangeArea) ~ scale(pi), compdata)
summary(mod_pi)
plot(mod_pi)

cor(alldiv$nidv, alldiv$totalbp, use = "pairwise.complete.obs")
cor(log10(alldiv$pi), (alldiv$bcd), use = "pairwise.complete.obs", method = "spearman")
cor(alldiv$bcd, alldiv$totalbp, use = "pairwise.complete.obs", method = "spearman")
cor(alldiv$nidv, alldiv$totalbp/alldiv$nidv, method = "spearman")
#
mod_bcd = pgls(log10(rangeArea) ~ scale(bcd) + scale(nidv), compdata)
summary(mod_bcd)

mod_pi = pgls(log10(rangeArea) ~ scale(pi) + scale(nidv), compdata)
summary(mod_pi)

plot(mod_bcd)

# try contrasts instead of variance-covariance matrices
alldiv$scale_bcd = scale(alldiv$bcd)
alldiv$scale_pi = scale(alldiv$pi)
alldiv$scale_jac = scale(alldiv$jac)
alldiv$scale_nidv = scale(alldiv$nidv)
alldiv$scale_bp_per_idv = scale(alldiv$totalbp/alldiv$nidv)
alldiv$log_range = log10(alldiv$rangeArea)

compdata = comparative.data(phy, alldiv, names.col = "species", vcv = T)

crunch_mod = crunch(log_range ~ scale_bcd + scale_pi + scale_nidv + scale_bp_per_idv, data = compdata)
summary(crunch_mod)
plot(crunch_mod)
```